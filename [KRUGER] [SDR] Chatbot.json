{
  "name": "[KRUGER] [SDR] Chatbot",
  "nodes": [
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        -6960,
        -1280
      ],
      "id": "a8cefff1-2a2f-4983-874c-89e67a212977",
      "name": "Convert to File"
    },
    {
      "parameters": {
        "content": "## ATUALIZA BASE DE CONHECIMENTO",
        "height": 460,
        "width": 1408,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -7936,
        -1440
      ],
      "typeVersion": 1,
      "id": "fdfdb5ed-d346-4b7c-a418-542ee692917a",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "dataType": "binary",
        "loader": "csvLoader",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.documentDefaultDataLoader",
      "typeVersion": 1,
      "position": [
        -6800,
        -1392
      ],
      "id": "b9497512-3125-4d59-ae84-caaa782a69be",
      "name": "Data Loader"
    },
    {
      "parameters": {
        "chunkOverlap": 100,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.textSplitterRecursiveCharacterTextSplitter",
      "typeVersion": 1,
      "position": [
        -6656,
        -1136
      ],
      "id": "599342cc-2823-4cef-8f58-478da7ee599d",
      "name": "Recursive Character Text Splitter"
    },
    {
      "parameters": {
        "mode": "insert",
        "tableName": {
          "__rl": true,
          "value": "={{ $('dados bc').first().json.TabelaBC }}",
          "mode": "id"
        },
        "options": {
          "queryName": "=match_{{ $('dados bc').first().json.TabelaBC }}"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1,
      "position": [
        -6800,
        -1280
      ],
      "id": "9c3c4386-12d8-462c-a6dc-e7ddfe5c6195",
      "name": "cria base conhecimento",
      "credentials": {
        "supabaseApi": {
          "id": "ICRwXhZLBgxPMEhm",
          "name": "[1] SUPABASE"
        }
      }
    },
    {
      "parameters": {
        "operation": "delete",
        "tableId": "={{ $('dados bc').first().json.TabelaBC }}",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "neq",
              "keyValue": "99999"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -7440,
        -1280
      ],
      "id": "d5f8d67e-e4f1-4396-9796-0e478aa2efdb",
      "name": "zera bc",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "ICRwXhZLBgxPMEhm",
          "name": "[1] SUPABASE"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "ce6300da-8ab5-415b-a661-e9ae0228d0da",
              "leftValue": "={{ $json.id }}",
              "rightValue": 1273123,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        -7296,
        -1280
      ],
      "id": "4d5d1d34-be59-479a-9cd2-675b6099283e",
      "name": "Filter",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "daysInterval": 3
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -7904,
        -1280
      ],
      "id": "e13be9b2-4b3e-49aa-abb9-f4135743b38d",
      "name": "3dias"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "e8c50e59-888b-438b-999b-061be34f55fa",
              "name": "TabelaBC",
              "value": "=bc{{ $json.Instancia.toLowerCase() }}sdr",
              "type": "string"
            },
            {
              "id": "281d8c89-c0f8-4787-882a-6165e433c2b6",
              "name": "Planilha",
              "value": "",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -7584,
        -1280
      ],
      "id": "30a95aa4-01c6-4d4b-bc37-78c7eb33bfc0",
      "name": "dados bc"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a00b2aa7-74ac-43a3-a91f-6e87181109c6",
              "name": "Instancia",
              "value": "KRUGER",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -7744,
        -1280
      ],
      "id": "55e0879f-f741-4d43-a82d-5017a8428f10",
      "name": "instancia"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "conhecimento",
        "returnAll": true,
        "filters": {
          "conditions": [
            {
              "keyName": "cliente",
              "condition": "eq",
              "keyValue": "={{ $('instancia').first().json.Instancia }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -7136,
        -1280
      ],
      "id": "64ab2269-92f5-4f05-a775-48339c26177e",
      "name": "puxa conhecimento1",
      "credentials": {
        "supabaseApi": {
          "id": "ICRwXhZLBgxPMEhm",
          "name": "[1] SUPABASE"
        }
      }
    },
    {
      "parameters": {
        "model": "text-embedding-3-large",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.1,
      "position": [
        -6800,
        -1136
      ],
      "id": "a3c000fc-ada3-46f6-9de1-7aad6b5a53f2",
      "name": "gpt8",
      "credentials": {
        "openAiApi": {
          "id": "nIAJKQcNsxgZl09A",
          "name": "[KRUGER] OPENAI"
        }
      }
    },
    {
      "parameters": {
        "content": "# Versão 1.0.0",
        "height": 80,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -7904,
        -1088
      ],
      "typeVersion": 1,
      "id": "4bc44e38-eb2e-4341-ab21-626a57af0c1a",
      "name": "Sticky Note23"
    },
    {
      "parameters": {
        "content": "",
        "height": 192,
        "width": 150,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -7776,
        -1312
      ],
      "typeVersion": 1,
      "id": "fb6ac0f1-7b2e-4f34-9f97-3bdf81d6472d",
      "name": "Sticky Note16"
    },
    {
      "parameters": {
        "content": "# FOLLOW UPs",
        "height": 99,
        "width": 529,
        "color": 5
      },
      "id": "eb4f5f1d-912b-4db1-8552-163286b97dfb",
      "name": "Sticky Note31",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -2832,
        -1584
      ]
    },
    {
      "parameters": {
        "content": "## Sistema de envio de follow-ups após mensagem do chatbot.",
        "height": 124.33377854085195,
        "width": 355.25753985841834
      },
      "id": "b3181b41-74f5-49d2-9f41-509f1a40c781",
      "name": "Sticky Note32",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -2800,
        -1360
      ]
    },
    {
      "parameters": {
        "content": "# FOLLOW UP",
        "height": 585,
        "width": 3385,
        "color": 7
      },
      "id": "e77aba64-4290-4d70-9c47-983421dbcaba",
      "name": "Sticky Note33",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -2832,
        -1456
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "46b9479c-bfbf-4140-b641-d0de67d6b8d2",
              "name": "Instancia",
              "value": "={{ $('fup').first().json.body.Instancia }}",
              "type": "string"
            },
            {
              "id": "93788f13-9dcf-4da9-b918-ecde7135e404",
              "name": "Whatsapp",
              "value": "={{ $('fup').first().json.body.Whatsapp }}",
              "type": "string"
            },
            {
              "id": "856bfc94-dc30-4ff3-835c-ca67d6706f2e",
              "name": "Tag",
              "value": "={{ $('fup').first().json.body.Tag }}",
              "type": "string"
            },
            {
              "id": "a9e0e026-089e-490f-b8db-de44d4011b13",
              "name": "Id_row",
              "value": "={{ $('fup').first().json.body.Id_database_row }}",
              "type": "string"
            },
            {
              "id": "30c907f2-0ee8-497f-88e6-fb86399d0e53",
              "name": "Data_mensagem",
              "value": "={{ $('fup').first().json.body.Data_mensagem }}",
              "type": "string"
            },
            {
              "id": "ad63f00e-5a95-4324-99fa-aae2177f6a3b",
              "name": "Nome",
              "value": "={{ $('fup').first().json.body.Nome_cliente }}",
              "type": "string"
            },
            {
              "id": "7a70ba7c-b6bf-43b2-9274-faefe8925a33",
              "name": "Horario_mensagem",
              "value": "={{ $('fup').first().json.body.Horario_da_ultima_mensagem }}",
              "type": "string"
            },
            {
              "id": "413c243d-779a-4f77-ac3c-f003d192b562",
              "name": "resposta_ia",
              "value": "={{ $('fup').first().json.body.resposta_ia }}",
              "type": "string"
            },
            {
              "id": "1921297e-46d9-4809-8672-14dadb5eb5f1",
              "name": "horario_comercial_fup",
              "value": "={{ $('fup').first().json.body.horario_comercial_fup }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "55ed44b7-3725-419a-b381-fd4b149df071",
      "name": "campos followup",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1936,
        -1392
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=<mensagem>\n{{ $('campos followup').first().json.resposta_ia }}\n</mensagem> ",
        "messages": {
          "messageValues": [
            {
              "message": "={{ $('fup').first().json.body.DecisaoFollowup }}"
            }
          ]
        }
      },
      "id": "ad2b961e-5c21-4cf9-89b5-561f989dc057",
      "name": "avalia msg",
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.4,
      "position": [
        -1728,
        -1152
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://webhook{{ $('fup').first().json.body.servidor }}.{{ $('fup').first().json.body.dominio }}/webhook/followupchatbotsdr{{ $('campos followup').first().json.Instancia.toLowerCase() }}",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "Instancia",
              "value": "={{ $('campos followup').first().json.Instancia }}"
            },
            {
              "name": "Whatsapp",
              "value": "={{ $('campos followup').first().json.Whatsapp }}"
            },
            {
              "name": "Nome_cliente",
              "value": "={{ $('fup').first().json.body.Nome_cliente }}"
            },
            {
              "name": "Data_mensagem",
              "value": "={{ $('fup').first().json.body.Data_mensagem }}"
            },
            {
              "name": "Id_database_row",
              "value": "={{ $('fup').first().json.body.Id_database_row }}"
            },
            {
              "name": "Tag",
              "value": "={{ $('fup').first().json.body.Tag }}"
            },
            {
              "name": "Horario_da_ultima_mensagem",
              "value": "={{ $('fup').first().json.body.Horario_da_ultima_mensagem }}"
            },
            {
              "name": "dominio",
              "value": "={{ $('fup').first().json.body.dominio }}"
            },
            {
              "name": "servidor",
              "value": "={{ $('fup').first().json.body.servidor }}"
            },
            {
              "name": "execution",
              "value": "={{ $execution.id }}"
            },
            {
              "name": "DecisaoFollowup",
              "value": "={{ $('fup').first().json.body.DecisaoFollowup }}"
            },
            {
              "name": "resposta_ia",
              "value": "={{ $('campos followup').first().json.resposta_ia }}"
            },
            {
              "name": "horario_comercial_fup",
              "value": "={{ $('campos followup').first().json.horario_comercial_fup }}"
            }
          ]
        },
        "options": {}
      },
      "id": "52f2b292-b620-4524-a98c-cb07f30eaf6f",
      "name": "proximo fup",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -208,
        -1152
      ],
      "executeOnce": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "f48f02a5-949c-4d8b-aa97-be528434b299",
              "leftValue": "={{ $json.resultado }}",
              "rightValue": "verdadeiro",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "3d3d6a00-18be-4a52-97e0-2e680e11aa02",
      "name": "verifica nova msg",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -2208,
        -1152
      ],
      "executeOnce": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "7ff13c54-ec32-4285-8493-e92fe295a2de",
              "leftValue": "={{ $json.text }}",
              "rightValue": "pergunta",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "9934362d-ce6e-45f3-a7ec-d51b30eaa7c0",
      "name": "pergunta ou final",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1456,
        -1152
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "9499ec5f-7d3d-4162-b43a-945346556e6f",
              "leftValue": "={{ $('puxa lead fup').first().json.followup[0].horario_especifico }}",
              "rightValue": "sim",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -768,
        -1392
      ],
      "id": "41719dd1-bf26-42ac-8729-6f59e5e31f5a",
      "name": "horario especifico"
    },
    {
      "parameters": {
        "amount": "={{ $('calcula horas').first().json.minutos_restantes }}",
        "unit": "minutes"
      },
      "id": "49c0b47a-35c7-4208-bcab-feb7f4679c16",
      "name": "aguarda especifico",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -624,
        -1392
      ],
      "webhookId": "2b644b7e-84d6-417d-a264-c7bd2d6365c1"
    },
    {
      "parameters": {
        "content": "## VERIFICA SE PRECISA FAZER FUP",
        "height": 217,
        "width": 428,
        "color": 4
      },
      "id": "9a9506f6-1698-473d-980b-e8e7e776df9f",
      "name": "Sticky Note19",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1760,
        -1200
      ]
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "=Execução: {{ $execution.id }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -2208,
        -1392
      ],
      "id": "862a62ff-a1b7-4992-9bb7-b51004af436a",
      "name": "responde fup"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "221dcb31-3205-4b57-849a-79d16bcee5a9",
              "leftValue": "={{ $('puxa lead fup').first().json.followup[0].comercial }}",
              "rightValue": "sim",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -336,
        -1392
      ],
      "id": "4d4a94e3-4df1-40cd-8b3e-c50cf5fd4c13",
      "name": "comercial"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "482f0bd5-d3e1-45cb-a39f-87dc91a758a9",
              "leftValue": "={{ $('puxa status').first().json.status }}",
              "rightValue": "on",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        416,
        -1392
      ],
      "id": "5535ae98-1c55-485b-98cf-c2c1332f2d1c",
      "name": "on off",
      "executeOnce": true
    },
    {
      "parameters": {
        "amount": "={{ ($('puxa lead fup').first().json.followup[0].horario_envio * 60) + $('puxa lead fup').first().json.followup[0].minutagem_envio }}",
        "unit": "minutes"
      },
      "id": "95d2a0be-6391-4d51-bd9f-e5093c9afc0b",
      "name": "aguarda minutagem",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -480,
        -1392
      ],
      "webhookId": "2b644b7e-84d6-417d-a264-c7bd2d6365c1"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('puxa lead fup').first().json.followup[0].tipo_midia }}",
                    "rightValue": "=texto",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "0b6f48fa-b803-4457-9d86-a98eddad977a"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "texto"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "dd7499d0-b64c-47be-b1aa-2e9164717de2",
                    "leftValue": "={{ $('puxa lead fup').first().json.followup[0].tipo_midia }}",
                    "rightValue": "imagem",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "imagem"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "20cf91f1-d1c1-4f50-be97-73e103b23f80",
                    "leftValue": "={{ $('puxa lead fup').first().json.followup[0].tipo_midia }}",
                    "rightValue": "áudio",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "áudio"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -1248,
        -1168
      ],
      "id": "b4bdcb21-3ace-4f09-b4c1-7ba2b46719e7",
      "name": "tipo midia"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://evolutionapi.eduardofischborn.com.br/message/sendText/{{ $('campos followup').first().json.Instancia }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "=55{{ $('campos followup').first().json.Whatsapp }}"
            },
            {
              "name": "text",
              "value": "={{ $json.texto }}"
            },
            {
              "name": "presence",
              "value": "composing"
            },
            {
              "name": "linkPreview",
              "value": "={{ false }}"
            },
            {
              "name": "delay",
              "value": "={{ 2500 }}"
            }
          ]
        },
        "options": {}
      },
      "id": "45dbe1cd-85d7-435e-9ba0-48e7830f0ffc",
      "name": "envia texto",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -944,
        -1152
      ],
      "executeOnce": true,
      "credentials": {
        "httpHeaderAuth": {
          "id": "rPARANITH2QYrjl5",
          "name": "[1] EVOLUTION"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://evolutionapi.eduardofischborn.com.br/message/sendMedia/{{ $('campos followup').first().json.Instancia }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "=55{{ $('campos followup').first().json.Whatsapp }}"
            },
            {
              "name": "mediatype",
              "value": "image"
            },
            {
              "name": "media",
              "value": "=https:{{ $('puxa lead fup').first().json.followup[0].conteudo_etapa }}"
            }
          ]
        },
        "options": {}
      },
      "id": "6b804f40-1b23-4577-8f2b-34748c6d7850",
      "name": "envia imagem",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -800,
        -1152
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "rPARANITH2QYrjl5",
          "name": "[1] EVOLUTION"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://evolutionapi.eduardofischborn.com.br/message/sendText/{{ $('campos followup').first().json.Instancia }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "=55{{ $('campos followup').first().json.Whatsapp }}"
            },
            {
              "name": "text",
              "value": "={{ $('puxa fup').first().json.conteudo_etapa }}"
            },
            {
              "name": "presence",
              "value": "composing"
            },
            {
              "name": "linkPreview",
              "value": "={{ false }}"
            },
            {
              "name": "delay",
              "value": "={{ 2500 }}"
            }
          ]
        },
        "options": {}
      },
      "id": "6d9312a9-a01f-4ef5-a491-c3b98221b146",
      "name": "envia audio",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -656,
        -1152
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "rPARANITH2QYrjl5",
          "name": "[1] EVOLUTION"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "={{ $('campos followup').first().json.Instancia.toLowerCase() }}_sdr_leads",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "whatsapp",
              "condition": "eq",
              "keyValue": "={{ $('campos followup').first().json.Whatsapp }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "ultimo_fup",
              "fieldValue": "={{ $('puxa lead fup').first().json.numero_proximo_fup.ordem }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -496,
        -1152
      ],
      "id": "fd9059fd-eba5-41cf-b870-2206d85fcaa9",
      "name": "atualiza fup",
      "credentials": {
        "supabaseApi": {
          "id": "ICRwXhZLBgxPMEhm",
          "name": "[1] SUPABASE"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Itera sobre cada item que chega ao nó\nfor (const item of $input.all()) {\n  try {\n    const horarioEnvio = item.json.followup[0].horario_envio;\n\n    // Se o campo estiver vazio ou nulo, pula para o próximo item\n    if (horarioEnvio == null) {\n      continue;\n    }\n\n    // Converte o número de 4 dígitos para uma string, garantindo que tenha 4 dígitos\n    const horarioString = String(horarioEnvio).padStart(4, '0');\n    const horas = parseInt(horarioString.substring(0, 2), 10);\n    const minutos = parseInt(horarioString.substring(2, 4), 10);\n\n    // Validação para garantir que as horas e minutos são válidos\n    if (horas > 23 || minutos > 59) {\n      item.json.erro = 'Horário de envio inválido.';\n      continue;\n    }\n\n    // Obtém a data e hora atuais a partir da variável $now do n8n\n    const agora = $now;\n\n    // Cria um objeto de data e hora para o horário de envio de hoje\n    let dataEnvio = agora.set({ hour: horas, minute: minutos, second: 0, millisecond: 0 });\n\n    // Se o horário de envio já passou hoje, define o cálculo para o dia seguinte\n    if (dataEnvio < agora) {\n      dataEnvio = dataEnvio.plus({ days: 1 });\n    }\n\n    // --- Linha de Depuração ---\n    // Você pode ver esses logs no console do desenvolvedor do seu navegador (F12)\n    console.log(`Hora Atual: ${agora.toISO()}`);\n    console.log(`Próximo Envio Agendado: ${dataEnvio.toISO()}`);\n    // -------------------------\n\n    // --- MUDANÇA PRINCIPAL AQUI ---\n    // Calcula a diferença EXATA em minutos\n    const diffEmMinutos = dataEnvio.diff(agora, 'minutes').toObject().minutes;\n\n    // Adiciona o resultado (minutos restantes) em um novo campo\n    // Arredondamos para ter um número inteiro de minutos.\n    item.json.minutos_restantes = Math.round(diffEmMinutos);\n\n  } catch (error) {\n    // Adiciona uma mensagem de erro ao item se algo falhar\n    item.json.erro = `Falha ao calcular minutos: ${error.message}`;\n  }\n}\n\n// Retorna os itens modificados\nreturn $input.all();"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1216,
        -1392
      ],
      "id": "cfeafe65-d78b-4b87-a381-2629974e6a74",
      "name": "calcula horas"
    },
    {
      "parameters": {
        "content": "# Versão 2.1.0",
        "height": 80,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        304,
        -976
      ],
      "typeVersion": 1,
      "id": "6d5e1cbc-5cbe-4a2e-950e-b4e847191262",
      "name": "Sticky Note22"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "followupchatbotsdrkruger",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "bf7018a1-a83d-43c8-9e0e-498476c7797e",
      "name": "fup",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -2352,
        -1392
      ],
      "webhookId": "0869168e-a201-47b3-b9e9-0302f7a8e56b"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH lead_rows AS (\n  SELECT *\n  FROM {{ $('campos followup').first().json.Instancia.toLowerCase() }}_sdr_leads\n  WHERE whatsapp = '{{ $('campos followup').first().json.Whatsapp }}'\n),\none_lead AS (\n  -- se vier mais de um, pega só um (ajuste o ORDER BY se precisar)\n  SELECT *\n  FROM lead_rows\n  ORDER BY id DESC\n  LIMIT 1\n),\nproxima_ordem AS (\n  -- soma +1 no ultimo_fup; se não houver lead, começa em 1\n  SELECT COALESCE(ol.ultimo_fup, 0) + 1 AS ordem\n  FROM one_lead ol\n  UNION ALL\n  SELECT 1 AS ordem\n  WHERE NOT EXISTS (SELECT 1 FROM one_lead)\n),\nmatched_followups AS (\n  SELECT f.*\n  FROM followups f\n  JOIN proxima_ordem po ON f.ordem = po.ordem\n  WHERE f.cliente = '{{ $('campos followup').first().json.Instancia }}'\n    AND f.workflow_id = (SELECT fluxo_followup FROM one_lead)\n)\nSELECT\n  -- OUTPUT 1: dados do(s) lead(s) encontrados\n  (SELECT COALESCE(jsonb_agg(to_jsonb(l)), '[]'::jsonb) FROM lead_rows l) AS lead_dados,\n\n  -- OUTPUT 2: { \"ordem\": <ultimo_fup + 1> }\n  (SELECT to_jsonb(po) FROM proxima_ordem po LIMIT 1) AS numero_proximo_fup,\n\n  -- OUTPUT 3: followups filtrados por cliente, ordem calculada e workflow_id do lead\n  (SELECT COALESCE(jsonb_agg(to_jsonb(mf)), '[]'::jsonb) FROM matched_followups mf) AS followup;\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1792,
        -1392
      ],
      "id": "fc5ec897-de58-40ae-93ba-8c0687e24fa3",
      "name": "puxa lead fup",
      "credentials": {
        "postgres": {
          "id": "mldxnwiYT8SHb9yL",
          "name": "[1] POSTGRES"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "443a96df-d3f6-4be9-ab4e-5e24529b4960",
              "leftValue": "={{ $('puxa lead fup').first().json.followup[0].nome_etapa }}",
              "rightValue": "FIM",
              "operator": {
                "type": "string",
                "operation": "notContains"
              }
            },
            {
              "id": "240290f5-d03e-44e7-8a5e-ae69d5dfeb4a",
              "leftValue": "={{ $('puxa lead fup').first().json.followup[0].conteudo_etapa }}",
              "rightValue": "FIM",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1504,
        -1392
      ],
      "id": "cc20b16d-7298-45c5-8b97-a9186bf6bcfa",
      "name": "followup final"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH tem_maior AS ( SELECT 1 FROM {{ $('campos followup').first().json.Instancia.toLowerCase() }}_sdr_conversas c WHERE trim(c.whatsapp) = trim('{{ $('campos followup').first().json.Whatsapp }}') AND trim(c.data_mensagem) = trim('{{ $('campos followup').first().json.Data_mensagem }}') AND trim(c.hora_mensagem) > trim('{{ $('campos followup').first().json.Horario_mensagem }}') LIMIT 1 ) SELECT CASE WHEN EXISTS (SELECT 1 FROM tem_maior) THEN 'verdadeiro' ELSE 'falso' END AS resultado;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2352,
        -1152
      ],
      "id": "bbc639be-925e-4fb0-bd9e-7fe9a689d50f",
      "name": "nova msg",
      "executeOnce": true,
      "credentials": {
        "postgres": {
          "id": "mldxnwiYT8SHb9yL",
          "name": "[1] POSTGRES"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// --- Util: normaliza string (acentos/espacos) ---\nconst strip = (s) =>\n  s\n    .toLowerCase()\n    .normalize('NFD').replace(/[\\u0300-\\u036f]/g, '')\n    .replace(/\\s+/g, ' ')\n    .trim();\n\nconst diasIdxToPt = ['domingo','segunda','terca','quarta','quinta','sexta','sabado'];\n\n// --- Ajuste de timezone manual para America/Sao_Paulo ---\nconst nowUTC = new Date($now);\nconst now = new Date(nowUTC.toLocaleString('en-US', { timeZone: 'America/Sao_Paulo' }));\n\nconst hh = now.getHours();\nconst mm = now.getMinutes();\nconst minutosAtuais = hh * 60 + mm;\nconst diaHoje = diasIdxToPt[now.getDay()];\n\n// --- Lê horários comerciais ---\nlet horariosStr =\n  ($json && $json.horario_comercial_fup) ??\n  ($node['campos followup']?.json?.horario_comercial_fup) ??\n  '';\n\nhorariosStr = String(horariosStr).trim().replace(/^\\[/, '').replace(/\\]$/, '');\nconst entradas = horariosStr\n  .split(',')\n  .map(e => strip(e))\n  .filter(Boolean);\n\n// Agrupa intervalos por dia\nconst mapa = {};\nfor (const ent of entradas) {\n  const m = ent.match(/^([a-z]+)\\s+(\\d{1,2}:\\d{2})-(\\d{1,2}:\\d{2})$/i);\n  if (!m) continue;\n\n  let [, dia, ini, fim] = m;\n  dia = strip(dia);\n\n  const toMin = (t) => {\n    const [H, M] = t.split(':').map(Number);\n    return H * 60 + M;\n  };\n  const iniMin = toMin(ini);\n  const fimMin = toMin(fim);\n\n  if (!mapa[dia]) mapa[dia] = [];\n  mapa[dia].push([iniMin, fimMin]);\n}\n\n// Verifica se está dentro\nlet dentro = false;\nfor (const [ini, fim] of (mapa[diaHoje] || [])) {\n  if (minutosAtuais >= ini && minutosAtuais <= fim) {\n    dentro = true;\n    break;\n  }\n}\n\nconst status = dentro ? 'dentro' : 'fora';\n\n// --- OUTPUT ---\nreturn [{\n  json: {\n    data_hora_atual: now.toISOString(), // Agora no horário de Brasília\n    hora_local: `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}`,\n    dia_semana: diaHoje,\n    status_horario: status\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -176,
        -1392
      ],
      "id": "e4f98213-0600-47eb-9ea8-82a68d10834a",
      "name": "filtro horario"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "80444d53-dfec-49bc-acf7-a7d269accf09",
              "leftValue": "={{ $json.status_horario }}",
              "rightValue": "dentro",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -32,
        -1392
      ],
      "id": "c10998a7-df6f-4796-a491-8a7211798515",
      "name": "verifica liberacao"
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "={{ $('campos followup').first().json.Instancia.toLowerCase() }}_sdr_leads",
        "filters": {
          "conditions": [
            {
              "keyName": "whatsapp",
              "keyValue": "={{ $('campos followup').first().json.Whatsapp }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        272,
        -1392
      ],
      "id": "e9ae19c0-fb76-4b9d-946a-2fe19f1beacf",
      "name": "puxa status",
      "credentials": {
        "supabaseApi": {
          "id": "ICRwXhZLBgxPMEhm",
          "name": "[1] SUPABASE"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "9499ec5f-7d3d-4162-b43a-945346556e6f",
              "leftValue": "={{ $('campos followup').first().json.Whatsapp }}",
              "rightValue": "5497068821",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "eacb0d9c-0f84-4039-9a0f-5a5139d70348",
              "leftValue": "={{ $('campos followup').first().json.Whatsapp }}",
              "rightValue": "5181427825",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1056,
        -1392
      ],
      "id": "b04c2a87-dc69-404a-86b0-5de411540156",
      "name": "telefone testes"
    },
    {
      "parameters": {
        "amount": 2,
        "unit": "minutes"
      },
      "id": "a5813f97-947f-4e43-b51c-9fc38ccf2c79",
      "name": "aguarda testes",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -912,
        -1392
      ],
      "webhookId": "2b644b7e-84d6-417d-a264-c7bd2d6365c1"
    },
    {
      "parameters": {
        "amount": 4,
        "unit": "hours"
      },
      "id": "8df12d99-307c-45b4-887b-161bfc51c40f",
      "name": "aguarda comercial",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        128,
        -1392
      ],
      "webhookId": "2b644b7e-84d6-417d-a264-c7bd2d6365c1"
    },
    {
      "parameters": {
        "tableId": "eventos",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "cliente",
              "fieldValue": "={{ $('campos followup').first().json.Instancia }}"
            },
            {
              "fieldId": "data",
              "fieldValue": "={{ $('campos followup').first().json.Data_mensagem }}"
            },
            {
              "fieldId": "horario",
              "fieldValue": "={{ $('campos followup').first().json.Horario_mensagem }}"
            },
            {
              "fieldId": "evento",
              "fieldValue": "followup"
            },
            {
              "fieldId": "origem",
              "fieldValue": "=whatsapp{{ $('campos followup').first().json.Whatsapp }}"
            },
            {
              "fieldId": "fluxo",
              "fieldValue": "chatbot"
            },
            {
              "fieldId": "conteudo",
              "fieldValue": "={{ $('puxa lead fup').first().json.followup[0].nome_etapa }}--{{ $('puxa lead fup').first().json.followup[0].workflow_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -352,
        -1152
      ],
      "id": "b7ddc422-0fd6-4be0-9e4a-96886681e0d2",
      "name": "evento fup",
      "credentials": {
        "supabaseApi": {
          "id": "ICRwXhZLBgxPMEhm",
          "name": "[1] SUPABASE"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "={{ $('campos followup').first().json.Instancia.toLowerCase() }}_sdr_leads",
        "filters": {
          "conditions": [
            {
              "keyName": "whatsapp",
              "condition": "eq",
              "keyValue": "={{ $('campos followup').first().json.Whatsapp }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "crm",
              "fieldValue": "DESCARTE"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -1360,
        -1392
      ],
      "id": "8d833be6-ba2c-4880-8b1c-d323f94e6d86",
      "name": "crm descarte",
      "credentials": {
        "supabaseApi": {
          "id": "ICRwXhZLBgxPMEhm",
          "name": "[1] SUPABASE"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -32,
        -1152
      ],
      "id": "02932648-0837-4b98-be7d-4166f24a9dbf",
      "name": "descarte crm externo",
      "executeOnce": true,
      "alwaysOutputData": true,
      "disabled": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "f48f02a5-949c-4d8b-aa97-be528434b299",
              "leftValue": "={{ ($('puxa lead fup').first().json.followup[0].horario_envio * 60) + $('puxa lead fup').first().json.followup[0].minutagem_envio }}",
              "rightValue": 360,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            },
            {
              "id": "9e994ed9-a9d3-4648-8a43-bd268e1cd32a",
              "leftValue": "={{ $('puxa lead fup').first().json.followup[0].horario_especifico }}",
              "rightValue": "nao",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "f028609c-f0c6-40d1-ad98-19cffb594919",
      "name": "pula delay minutagem",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -2048,
        -1152
      ],
      "executeOnce": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "f48f02a5-949c-4d8b-aa97-be528434b299",
              "leftValue": "={{ $('calcula horas').first().json.minutos_restantes }}",
              "rightValue": 360,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            },
            {
              "id": "02760376-f7bc-4c03-ba44-85b96bf578dd",
              "leftValue": "={{ $('puxa lead fup').first().json.followup[0].horario_especifico }}",
              "rightValue": "sim",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "f2855792-1436-40c9-959b-55626c1068ed",
      "name": "pula delay especifico",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -1888,
        -1152
      ],
      "executeOnce": true
    },
    {
      "parameters": {
        "jsCode": "// Acessa o conteúdo original\nconst conteudo = $('puxa lead fup').first().json.followup[0].conteudo_etapa || \"\";\n\n// Acessa o nome\nlet nome = $('campos followup').first().json.Nome;\n\n// Se o nome for nulo, vazio ou apenas espaços, substitui por \"amigo\"\nif (!nome || nome.trim() === \"\") {\n  nome = \"amigo\";\n}\n\n// Faz a substituição apenas se houver \"<nome>\" no texto\nconst textoFinal = conteudo.includes(\"<nome>\")\n  ? conteudo.replaceAll(\"<nome>\", nome)\n  : conteudo;\n\n// Retorna o texto final\nreturn [{ texto: textoFinal }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1088,
        -1152
      ],
      "id": "d64f1ca4-3c0e-4fdd-97bb-9d10cf2a4354",
      "name": "variavel texto"
    },
    {
      "parameters": {
        "dataToSave": {
          "values": [
            {
              "key": "whatsapp",
              "value": "={{ $('fup').first().json.body.Whatsapp }}"
            },
            {
              "key": "nome",
              "value": "={{ $('fup').first().json.body.Nome_cliente }}"
            },
            {
              "key": "fluxo",
              "value": "followup"
            },
            {
              "key": "id_supabase",
              "value": "={{ $('fup').first().json.body.Id_database_row }}"
            },
            {
              "key": "data",
              "value": "={{ $('fup').first().json.body.Data_mensagem }}"
            },
            {
              "key": "horario",
              "value": "={{ $('fup').first().json.body.Horario_da_ultima_mensagem }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executionData",
      "typeVersion": 1.1,
      "position": [
        -2064,
        -1392
      ],
      "id": "f5c89e70-6cb4-4b73-8ca1-22aab956a401",
      "name": "highlight fup"
    },
    {
      "parameters": {
        "model": "gpt-4.1",
        "options": {
          "temperature": 0.2
        }
      },
      "id": "245cfbb6-5ad0-4fc3-835e-3e8346e5bbed",
      "name": "gpt10",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [
        -1600,
        -1088
      ],
      "credentials": {
        "openAiApi": {
          "id": "nIAJKQcNsxgZl09A",
          "name": "[KRUGER] OPENAI"
        }
      }
    },
    {
      "parameters": {
        "content": "## DESCARTE CRM EXTERNO",
        "height": 217,
        "width": 364,
        "color": 3
      },
      "id": "6c412901-b5e3-472c-8676-414d432c5450",
      "name": "Sticky Note24",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -80,
        -1200
      ]
    },
    {
      "parameters": {
        "content": "",
        "width": 150,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -2384,
        -1408
      ],
      "typeVersion": 1,
      "id": "5b5545d2-3f3e-4bac-b013-33a0e0a55e97",
      "name": "Sticky Note26"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "443a96df-d3f6-4be9-ab4e-5e24529b4960",
              "leftValue": "={{ $('puxa lead fup').first().json.followup[0].nome_etapa }}",
              "rightValue": "FIM",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1648,
        -1392
      ],
      "id": "7f8a622c-aaf2-4d33-b940-a7684e9ed718",
      "name": "fup existe"
    },
    {
      "parameters": {
        "content": "# CHATBOT DE IA",
        "height": 99,
        "width": 529,
        "color": 5
      },
      "id": "fed5b8ff-1be3-4e37-a6e5-9b785496702c",
      "name": "Sticky Note21",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -6464,
        -1584
      ]
    },
    {
      "parameters": {
        "content": "#              LOUVADO SEJA DEUS",
        "height": 80,
        "width": 412,
        "color": 6
      },
      "id": "022e4883-c133-4d90-84c5-486e6cd7fa46",
      "name": "Sticky Note",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -6432,
        -1008
      ]
    },
    {
      "parameters": {
        "content": "# RECEBE MENSAGEM",
        "height": 296,
        "width": 1274
      },
      "id": "9d92e16c-268a-4fac-8ed5-e047d19d634d",
      "name": "Sticky Note1",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -6000,
        -1376
      ]
    },
    {
      "parameters": {
        "content": "## AGENTE SDR\n ",
        "height": 465,
        "width": 784,
        "color": 4
      },
      "id": "3d37d374-4f6c-4419-b70d-abeedbe5399d",
      "name": "Sticky Note6",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -4464,
        -896
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('dados base').first().json.evolution_url }}message/sendText/{{ $('dados mensagem').first().json.Instancia }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "=55{{ $('recebe dados').first().json.body.Whatsapp }}"
            },
            {
              "name": "text",
              "value": "={{ $json.RespostasPicotadasFlowise }}"
            },
            {
              "name": "presence",
              "value": "composing"
            },
            {
              "name": "linkPreview",
              "value": "={{ false }}"
            },
            {
              "name": "delay",
              "value": "={{ 2500 }}"
            }
          ]
        },
        "options": {}
      },
      "id": "c997ca44-0409-4891-ac48-90806091feaa",
      "name": "RESPONDE NO ZAP - TEXTO",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -4576,
        96
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "rPARANITH2QYrjl5",
          "name": "[1] EVOLUTION"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "a4d55bf8-3f03-45a1-ab20-90b38a7c52c4",
      "name": "Loop Over Items",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -4752,
        96
      ]
    },
    {
      "parameters": {
        "content": "## DIVIDE RESPOSTA EM BLOCOS",
        "height": 290,
        "width": 1016,
        "color": 5
      },
      "id": "683ae18c-9537-436a-93d4-4ee32e7f37ad",
      "name": "Sticky Note5",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -5296,
        16
      ]
    },
    {
      "parameters": {
        "content": "## ARMAZENA MENSAGENS NO SUPABASE",
        "height": 461,
        "width": 656,
        "color": 6
      },
      "id": "c15418b3-64bb-4b55-842c-3c120d110a37",
      "name": "Sticky Note8",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -6016,
        -320
      ]
    },
    {
      "parameters": {
        "tableId": "={{ $('dados base').first().json.TabelaConversas }}",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "whatsapp",
              "fieldValue": "={{ $('recebe dados').first().json.body.Whatsapp }}"
            },
            {
              "fieldId": "nome_cliente",
              "fieldValue": "={{ $('dados mensagem').first().json.Nome }}"
            },
            {
              "fieldId": "data_mensagem",
              "fieldValue": "={{ $('data hora').first().json.data_envio_mensagem }}"
            },
            {
              "fieldId": "hora_mensagem",
              "fieldValue": "={{ $('data hora').first().json.horario_envio_mensagem }}"
            },
            {
              "fieldId": "texto_cliente",
              "fieldValue": "={{ $('agrupa mensagens').first().json.MensagensAgrupadas }}"
            },
            {
              "fieldId": "texto_resposta_ia",
              "fieldValue": "={{ $('AI Agent').first().json.output }}"
            }
          ]
        }
      },
      "id": "6a109a1e-d8d1-4d75-bf48-52dd193567c6",
      "name": "salva msg banco de dados",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -5840,
        -240
      ],
      "credentials": {
        "supabaseApi": {
          "id": "ICRwXhZLBgxPMEhm",
          "name": "[1] SUPABASE"
        }
      }
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "={{ $('dados base').first().json.TabelaConversas }}",
        "limit": 1,
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "whatsapp",
              "condition": "eq",
              "keyValue": "={{ $('dados mensagem').first().json.Whatsapp }}"
            },
            {
              "keyName": "primeira_mensagem",
              "condition": "eq",
              "keyValue": "sim"
            }
          ]
        }
      },
      "id": "13ac905c-9962-4e43-9813-11c238648277",
      "name": "procura primeira msg",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -3568,
        -1088
      ],
      "alwaysOutputData": true,
      "executeOnce": true,
      "credentials": {
        "supabaseApi": {
          "id": "ICRwXhZLBgxPMEhm",
          "name": "[1] SUPABASE"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "7061470c-35c2-4116-92eb-4774d6b0bbe4",
              "name": "Nome",
              "value": "={{ $('recebe dados').first().json.body.Nome }}",
              "type": "string"
            },
            {
              "id": "2e09003a-d409-40e3-81b8-747c73ce125d",
              "name": "Whatsapp",
              "value": "={{ $('recebe dados').first().json.body.Whatsapp }}",
              "type": "string"
            },
            {
              "id": "fbb3c98e-ebe0-485e-83ba-88682eb16f68",
              "name": "Funil",
              "value": "={{ $('recebe dados').first().json.body.Funil }}",
              "type": "string"
            },
            {
              "id": "439aba6c-9964-4df4-b7fb-be40692155f6",
              "name": "Mensagem",
              "value": "={{ $('recebe dados').first().json.body.Mensagem }}",
              "type": "string"
            },
            {
              "id": "ef698cc5-46cd-4e4f-b4b7-293059908984",
              "name": "Horario",
              "value": "={{ $json.horario_envio_mensagem }}",
              "type": "string"
            },
            {
              "id": "d97e5fc3-44be-4f0f-9ffd-7cbf8a3fd056",
              "name": "Data",
              "value": "={{ $json.data_envio_mensagem }}",
              "type": "string"
            },
            {
              "id": "a9b04cbd-1377-4347-809e-a1c1a81afb7a",
              "name": "Instancia",
              "value": "={{ $('recebe dados').first().json.body.Instancia }}",
              "type": "string"
            },
            {
              "id": "20c36646-5a24-4425-b596-0d921a19b4fe",
              "name": "Tag",
              "value": "=TRIAGEM",
              "type": "string"
            },
            {
              "id": "7bae7789-3d0e-4fc0-906e-d917cf8a52d8",
              "name": "GrupoZap",
              "value": "={{ $('recebe dados').first().json.body.GrupoZap }}",
              "type": "string"
            },
            {
              "id": "510d185d-606c-427d-b68c-d882075ae869",
              "name": "Followup",
              "value": "={{ $('recebe dados').first().json.body.Followup }}",
              "type": "string"
            },
            {
              "id": "4e9ad656-7b78-4fc6-a76a-2b8c87a71e8e",
              "name": "estado_atual",
              "value": "={{ $('recebe dados').first().json.body.estado_atual }}",
              "type": "string"
            },
            {
              "id": "cddbb7e2-c6d7-43aa-8922-2c510172e5ce",
              "name": "missao_prompt",
              "value": "={{ $('recebe dados').first().json.body.missao_prompt }}",
              "type": "string"
            },
            {
              "id": "2d054b2b-688e-429b-b4b1-c2f932a838e5",
              "name": "rotas_disponiveis",
              "value": "={{ $('recebe dados').first().json.body.rotas_disponiveis }}",
              "type": "string"
            },
            {
              "id": "6607b713-8270-461b-9027-f8a523cda01a",
              "name": "ferramentas",
              "value": "={{ $('recebe dados').first().json.body.ferramentas }}",
              "type": "string"
            },
            {
              "id": "3f8f810e-45e8-42c2-9af1-29542d18c362",
              "name": "log",
              "value": "={{ $('recebe dados').first().json.body.log }}",
              "type": "string"
            },
            {
              "id": "e60501bc-6a05-47ac-a3c9-1c533e01acfc",
              "name": "TelefoneAvisos",
              "value": "=5481590037",
              "type": "string"
            },
            {
              "id": "dc34b7b2-2490-4db1-bc34-c3b9c10206f6",
              "name": "Email",
              "value": "={{ $('recebe dados').first().json.body.Email }}",
              "type": "string"
            },
            {
              "id": "c8723ab2-f010-4a7f-806e-df75637830c8",
              "name": "dados",
              "value": "={{ $('recebe dados').first().json.body.dados }}",
              "type": "string"
            },
            {
              "id": "27f32b0f-cbde-4d3d-b8f0-a7eeab0c5050",
              "name": "FluxoAgendamentos",
              "value": "=https://webhook.eduardofischborn.com.br/webhook/lembretechatbotsdr{{ $('recebe dados').first().json.body.Instancia.toLowerCase() }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "89ebe61c-adf0-41d2-ab56-1443cb91bae0",
      "name": "dados mensagem",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -5360,
        -1280
      ]
    },
    {
      "parameters": {
        "tableId": "={{ $('dados base').first().json.TabelaConversas }}",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "whatsapp",
              "fieldValue": "={{ $('recebe dados').first().json.body.Whatsapp }}"
            },
            {
              "fieldId": "nome_cliente",
              "fieldValue": "={{ $('recebe dados').first().json.body.Nome }}"
            },
            {
              "fieldId": "data_mensagem",
              "fieldValue": "={{ $('data hora').first().json.data_envio_mensagem }}"
            },
            {
              "fieldId": "hora_mensagem",
              "fieldValue": "={{ $('data hora').first().json.horario_envio_mensagem }}"
            },
            {
              "fieldId": "texto_cliente",
              "fieldValue": "={{ $('agrupa mensagens').first().json.MensagensAgrupadas }}"
            },
            {
              "fieldId": "texto_resposta_ia",
              "fieldValue": "="
            },
            {
              "fieldId": "primeira_mensagem",
              "fieldValue": "sim"
            }
          ]
        }
      },
      "id": "7523eb39-559c-4aec-882e-88c17ad2da26",
      "name": "salva primeira msg banco de dados",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -3200,
        -1088
      ],
      "credentials": {
        "supabaseApi": {
          "id": "ICRwXhZLBgxPMEhm",
          "name": "[1] SUPABASE"
        }
      }
    },
    {
      "parameters": {
        "content": "## PRIMEIRA MENSAGEM?",
        "height": 238,
        "width": 671,
        "color": 2
      },
      "id": "39f68565-fec2-42d9-8024-b9bd1641932f",
      "name": "Sticky Note7",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -3584,
        -1152
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "1b1ebe27-9a02-4276-b7cf-c2364c9824bc",
              "leftValue": "={{ $json.id }}",
              "rightValue": "",
              "operator": {
                "type": "number",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "253daaef-b514-4c87-96bd-a80717e5e889",
      "name": "verifica se já tem mensagem",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3392,
        -1088
      ],
      "alwaysOutputData": false,
      "executeOnce": true
    },
    {
      "parameters": {
        "jsCode": "for (const item of $input.all()) {\n  let fullText = $('separa mensagens da ia').item.json.text;\n\n  // Divide pelas ocorrências literais de /n\n  const textItems = fullText.split('/n');\n\n  // Remove espaços e descarta vazios\n  return textItems\n    .map(textItem => textItem.trim())\n    .filter(textItem => textItem !== '')\n    .map(textItem => ({\n      json: {\n        RespostasPicotadasFlowise: textItem\n      }\n    }));\n}\n"
      },
      "id": "83435836-5fc9-49f9-b4f3-6c9ee711eb7b",
      "name": "picota respostas da IA",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4944,
        96
      ]
    },
    {
      "parameters": {
        "content": "# CLIENTE:\n#       MODELO",
        "height": 129.19985194312736,
        "width": 391.9230134079477,
        "color": 4
      },
      "id": "b3aea91e-45ef-4ae2-940a-4d7b5ca93eb6",
      "name": "Sticky Note13",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -6432,
        -1184
      ]
    },
    {
      "parameters": {
        "content": "# SDR",
        "height": 1889,
        "width": 3591,
        "color": 7
      },
      "id": "20fac390-b211-4713-9b11-dc010f6ca1b7",
      "name": "Sticky Note17",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -6464,
        -1456
      ]
    },
    {
      "parameters": {
        "content": "## Fluxo de atendimento da IA",
        "height": 88.34199434989154,
        "width": 355.25753985841834
      },
      "id": "9c82ef51-34c2-4230-bb14-19635138fc6c",
      "name": "Sticky Note18",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -6432,
        -1328
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=<mensagem>\n{{ $('AI Agent').first().json.output }}\n</mensagem>",
        "messages": {
          "messageValues": [
            {
              "message": "=<prompt>\n{{ $('puxa agente').first().json.escrita }}\n</prompt>"
            }
          ]
        }
      },
      "id": "00e9bcb2-8fc7-4a64-89ff-0917c8faba2c",
      "name": "separa mensagens da ia",
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.4,
      "position": [
        -5264,
        96
      ],
      "executeOnce": true
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "chatbotsdrkruger",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "7d8f68bf-fcc2-4028-a6fc-69632a13341c",
      "name": "recebe dados",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -5920,
        -1280
      ],
      "webhookId": "11593df1-5590-482b-8543-3a38c1a9cdbd"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Nome: {{ $('dados mensagem').first().json.Nome }}\nEmail: {{ $('dados mensagem').first().json.Email }}\nSessionID: {{ $('recebe dados').first().json.body.Whatsapp }}\nQ: {{ $('agrupa mensagens').first().json.MensagensAgrupadas }}\n\nData atual: {{ $now.setZone('America/Sao_Paulo').toISO() }}",
        "options": {
          "systemMessage": "=<identidade>\n{{ $('puxa agente').first().json.personalidade }}\n</identidade>\n\n<regras>\n# 2. REGRAS OPERACIONAIS E FERRAMENTAS\n\n// - **Busca de Informação:** Quando o cliente fizer uma pergunta sobre nossos serviços, nossa empresa, ou apresentar uma objeção específica, você DEVE usar a ferramenta `data_retriever` para buscar a resposta em nossa base de conhecimento antes de responder. Não invente informações. Se não encontrar, informe que não possui a resposta e continue o fluxo.\n{{ $('puxa agente').first().json.proibicoes }}\n{{ $('puxa agente').first().json.horarios_agendamento }}\n</regras>\n\n<tarefa>\n# 3. SUA TAREFA OBRIGATÓRIA E ÚNICA\nSua única tarefa nesta rodada é executar a 'MISSÃO' fornecida abaixo, formulando uma resposta para o cliente de forma conversacional, mantendo sua personalidade.\n\n**REGRAS CRÍTICAS DE EXECUÇÃO:**\n- **FOCO TOTAL:** Sua resposta deve ser 100% focada na missão atual. NÃO mencione tópicos ou frases de missões anteriores.\n- **NÃO ADIVINHE:** Não tente adivinhar os próximos passos do fluxo ou se antecipar. Apenas execute a tarefa presente.\n- **NÃO AGENDE (A MENOS QUE ORDENADO):** Não tente agendar uma reunião a menos que a missão explicitamente peça isso.\n- **USE FERRAMENTAS QUANDO NECESSÁRIO:** Se a missão exigir uma informação que você não sabe (sobre a empresa, serviços, ou para quebrar uma objeção), use a ferramenta `data_retriever`.\n</task>\n\n<contexto>\n# 4. CONTEXTO PARA SUA AÇÃO\n\n## HISTÓRICO DA CONVERSA:\n{{ $('concatena memoria').first().json.conversa_concatenada }}\n\n## RACIOCÍNIO (O QUE FOI PENSADO PARA ESSA MISSÃO TER SIDO ESCOLHIDA): \n{{ $('escolhe state').last().json.text }}\n\n## MISSÃO (O QUE VOCÊ DEVE FAZER/PERGUNTAR AGORA):\n\"{{ $('puxa regras').last().json.missao_prompt }}\"\n</contexto>\n\n<output>\n# 5. SUA RESPOSTA PARA O CLIENTE\n\n</output>"
        }
      },
      "id": "a17a7c1c-6027-4053-b665-0681c72c4284",
      "name": "AI Agent",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        -4416,
        -832
      ],
      "retryOnFail": true,
      "maxTries": 5
    },
    {
      "parameters": {
        "name": "data_retriever",
        "description": "=# **Use this tool every single time before answering an user's question.**\n\n# **Use essa ferramenta toda vez que o cliente apresentar alguma objeção**\n\nBanco de dados com todo o conhecimento sobre a empresa. Use esse ferramenta toda vez que precisar responder alguma pergunta sobre a empresa ou fornecer alguma informação.\n\n**Você será penalizado se responder o usuário sem usar essa ferramenta primeiro.**",
        "topK": 10
      },
      "type": "@n8n/n8n-nodes-langchain.toolVectorStore",
      "typeVersion": 1,
      "position": [
        -4112,
        -656
      ],
      "id": "ca150c66-036d-4b7c-a0b2-098b164f5b22",
      "name": "Vector Store Tool"
    },
    {
      "parameters": {
        "tableName": {
          "__rl": true,
          "value": "={{ $('dados base').first().json.TabelaBC }}",
          "mode": "id"
        },
        "options": {
          "queryName": "=match_{{ $('dados base').first().json.TabelaBC }}"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1,
      "position": [
        -4416,
        -656
      ],
      "id": "9f0b4729-ded4-47c2-baad-aa38882a6fd2",
      "name": "puxa conhecimento",
      "credentials": {
        "supabaseApi": {
          "id": "ICRwXhZLBgxPMEhm",
          "name": "[1] SUPABASE"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('dados base').first().json.evolution_url }}message/sendText/{{ $('dados mensagem').first().json.Instancia }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "={{ $('dados mensagem').item.json.GrupoZap }}"
            },
            {
              "name": "text",
              "value": "=💬 | **NOVO CONTATO** |\n\n📜 **Informações**\n• `Telefone:` – {{ $('dados mensagem').item.json.Whatsapp }}"
            },
            {
              "name": "presence",
              "value": "composing"
            },
            {
              "name": "linkPreview",
              "value": "={{ false }}"
            },
            {
              "name": "delay",
              "value": "={{ 2500 }}"
            }
          ]
        },
        "options": {}
      },
      "id": "2f246ac9-d7a5-44dd-95ca-c3e2b73590fd",
      "name": "avisa novo contato zap",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -3040,
        -1088
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "rPARANITH2QYrjl5",
          "name": "[1] EVOLUTION"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "ea18deaa-0933-463f-8832-1be81a508ef0",
              "leftValue": "={{ $('dados mensagem').first().json.Followup }}",
              "rightValue": "NAO",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3392,
        96
      ],
      "id": "ae978861-eee0-476d-bcb3-e874e7f9bd00",
      "name": "condicional fup"
    },
    {
      "parameters": {
        "content": "## FOLLOW UP",
        "height": 256,
        "width": 332,
        "color": 5
      },
      "id": "a133a529-b678-417e-b641-e13abe9860f7",
      "name": "Sticky Note14",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -3440,
        16
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://webhook{{ $('puxa agente').first().json.servidor }}.{{ $('puxa agente').first().json.dominio }}/webhook/followupchatbotsdr{{ $('dados mensagem').first().json.Instancia.toLowerCase() }}",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "Horario_da_ultima_mensagem",
              "value": "={{ $('salva msg banco de dados').first().json.hora_mensagem }}"
            },
            {
              "name": "Whatsapp",
              "value": "={{ $('salva msg banco de dados').first().json.whatsapp }}"
            },
            {
              "name": "Nome_cliente",
              "value": "={{ $('salva msg banco de dados').first().json.nome_cliente }}"
            },
            {
              "name": "Data_mensagem",
              "value": "={{ $('salva msg banco de dados').first().json.data_mensagem }}"
            },
            {
              "name": "Id_database_row",
              "value": "={{ $('salva msg banco de dados').first().json.id }}"
            },
            {
              "name": "Tag",
              "value": "={{ $('dados mensagem').first().json.Tag }} "
            },
            {
              "name": "Instancia",
              "value": "={{ $('dados mensagem').first().json.Instancia }}"
            },
            {
              "name": "servidor",
              "value": "={{ $('puxa agente').first().json.servidor }}"
            },
            {
              "name": "dominio",
              "value": "={{ $('puxa agente').first().json.dominio }}"
            },
            {
              "name": "execution",
              "value": "={{$execution.id}}"
            },
            {
              "name": "DecisaoFollowup",
              "value": "={{ $('puxa agente').first().json.decisor_followup }}"
            },
            {
              "name": "resposta_ia",
              "value": "={{ $('AI Agent').first().json.output }}"
            },
            {
              "name": "horario_comercial_fup",
              "value": "={{ $('puxa agente').first().json.horario_comercial_fup }}"
            }
          ]
        },
        "options": {}
      },
      "id": "5cddc432-c1b9-4963-89fa-b02d012c8b87",
      "name": "fluxo do followup",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -3248,
        96
      ],
      "executeOnce": true
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('recebe dados').first().json.body.Whatsapp }}",
        "tableName": "={{ $('dados base').first().json.TabelaMemoria }}",
        "contextWindowLength": 20
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        -4080,
        -848
      ],
      "id": "36497e93-40ff-4baa-b8b5-874d3d4305fb",
      "name": "memoria",
      "credentials": {
        "postgres": {
          "id": "mldxnwiYT8SHb9yL",
          "name": "[1] POSTGRES"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Analise o texto a seguir:\n\n<mensagem>\n{{ $('AI Agent').first().json.output }}\n</mensagem>",
        "messages": {
          "messageValues": [
            {
              "message": "=<task> Você é um agente avaliador de respostas geradas por IA.\nSua missão é analisar o texto da resposta dada pela IA para decidir se ela efetivamente respondeu à pergunta original feita pelo usuário.\n\nRegras para classificar:\n\nRETORNE \"SEM RESPOSTA\" somente se a resposta contiver uma NEGATIVA explícita, incerteza clara, evasão evidente ou indicação direta de falta de dados, por exemplo:\n\nFrases como \"Desculpe, não tenho informações sobre isso.\"\n\n\"Não posso afirmar com certeza...\"\n\n\"Minha base de dados não cobre esse assunto.\"\n\n\"Essa é uma questão em aberto...\"\n\nUso excessivo de condicionais para evitar a resposta (\"pode ser que\", \"talvez\", \"não sei\")\n\nPara QUALQUER OUTRO TIPO DE RESPOSTA, incluindo saudações, perguntas para o usuário, respostas parciais ou interações iniciais, RETORNE \"COM RESPOSTA\".\n\nA saída deve ser apenas a string \"COM RESPOSTA\" ou \"SEM RESPOSTA\".\n\nAnalise o texto abaixo:\n\n<resposta_ia>\n{{RESPOSTA_DA_IA}}\n</resposta_ia>\n</task>"
            }
          ]
        }
      },
      "id": "b2b5444b-01e7-4d39-9e4c-3394c08d8402",
      "name": "avalia falta resposta",
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.4,
      "position": [
        -5280,
        -240
      ],
      "disabled": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "5bceed0b-8454-43d1-90f2-a4942318a690",
              "leftValue": "={{ $json.text }}",
              "rightValue": "SEM RESPOSTA",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -4960,
        -240
      ],
      "id": "cd5c7313-97d4-4a13-b0ba-179725ac2cd4",
      "name": "com ou sem resposta",
      "disabled": true
    },
    {
      "parameters": {
        "tableId": "={{ $('dados base').first().json.TabelaLeads }}",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "Whatsapp",
              "fieldValue": "={{ $('salva msg banco de dados').item.json.Whatsapp }}"
            },
            {
              "fieldId": "Tag",
              "fieldValue": "off"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -4784,
        -240
      ],
      "id": "858b0de1-c5b5-46e8-b646-d34c3c1b17fb",
      "name": "cria row tag off",
      "disabled": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('dados base').first().json.evolution_url }}message/sendText/{{ $('dados mensagem').first().json.Instancia }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "=5551993509029"
            },
            {
              "name": "text",
              "value": "=📈 | **REPASSE ATENDIMENTO** |\n\n📅  *Data: {{ $('dados mensagem').first().json.Data }} | 🕒 {{ $('dados mensagem').first().json.Horario }}*\n\n📞 • `Telefone` - *{{ $('dados mensagem').first().json.Whatsapp }}*\n\n💬 • `Mensagem:` - *{{ $('dados mensagem').first().json.Mensagem }}*\n\n\n\n"
            },
            {
              "name": "presence",
              "value": "composing"
            },
            {
              "name": "linkPreview",
              "value": "={{ false }}"
            },
            {
              "name": "delay",
              "value": "={{ 2500 }}"
            }
          ]
        },
        "options": {}
      },
      "id": "f785375b-5f80-4ee1-a261-5629578578a2",
      "name": "envia aviso zap",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -4656,
        -240
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "rPARANITH2QYrjl5",
          "name": "[1] EVOLUTION"
        }
      },
      "disabled": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('dados base').first().json.evolution_url }}message/sendText/{{ $('dados mensagem').first().json.Instancia }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "=55{{ $('dados mensagem').first().json.Whatsapp }}"
            },
            {
              "name": "text",
              "value": "=Pedimos desculpas, mas, infelizmente, não disponho das informações solicitadas no momento. Para melhor atendê-lo, estou encaminhando seu atendimento a um de nossos especialistas. 🙂"
            },
            {
              "name": "presence",
              "value": "composing"
            },
            {
              "name": "linkPreview",
              "value": "={{ false }}"
            },
            {
              "name": "delay",
              "value": "={{ 2500 }}"
            }
          ]
        },
        "options": {}
      },
      "id": "6f28535d-8c64-4aeb-8e0d-03686ed0756a",
      "name": "avisa cliente",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -4512,
        -240
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "rPARANITH2QYrjl5",
          "name": "[1] EVOLUTION"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "content": "## REPASSA P/ ATENDENTE HUMANO",
        "height": 272,
        "width": 892,
        "color": 4
      },
      "id": "e5d15a70-cdaf-465f-b6f7-e25afbc9bfb9",
      "name": "Sticky Note15",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -5296,
        -304
      ]
    },
    {
      "parameters": {
        "tableId": "mensagens",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "cliente",
              "fieldValue": "={{ $('dados mensagem').first().json.Instancia.toUpperCase() }}"
            },
            {
              "fieldId": "whatsapp",
              "fieldValue": "={{ $('dados mensagem').first().json.Whatsapp }}"
            },
            {
              "fieldId": "autor",
              "fieldValue": "=IA"
            },
            {
              "fieldId": "destino",
              "fieldValue": "={{ $('dados mensagem').first().json.Whatsapp }}"
            },
            {
              "fieldId": "conteudo",
              "fieldValue": "={{ $('AI Agent').first().json.output }}"
            },
            {
              "fieldId": "criado_em",
              "fieldValue": "={{ $('data hora').first().json.timestamp_iso }}"
            },
            {
              "fieldId": "hora_mensagem",
              "fieldValue": "={{ $('data hora').first().json.horario_envio_mensagem }}"
            },
            {
              "fieldId": "raciocinio_ia",
              "fieldValue": "={{ $('escolhe state').first().json.text }} \nNº execução: {{$execution.id}}"
            }
          ]
        }
      },
      "id": "93dedc1a-4a7a-40a0-ac86-9ba15ffab361",
      "name": "salva msg ia bubble",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -5680,
        -240
      ],
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "ICRwXhZLBgxPMEhm",
          "name": "[1] SUPABASE"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "6c01bf0c-8536-4877-bfc9-6e6947de94cf",
              "name": "TabelaConversas",
              "value": "={{ $('dados mensagem').first().json.Instancia.toLowerCase() }}_sdr_conversas",
              "type": "string"
            },
            {
              "id": "aa7c2b65-ea34-46ff-90a6-2eccf300914e",
              "name": "TabelaLeads",
              "value": "={{ $('dados mensagem').first().json.Instancia.toLowerCase() }}_sdr_leads",
              "type": "string"
            },
            {
              "id": "7d1d9088-f98e-4cec-85f3-514d3c33796e",
              "name": "TabelaTemp",
              "value": "={{ $('dados mensagem').first().json.Instancia.toLowerCase() }}_sdr_temp",
              "type": "string"
            },
            {
              "id": "7163817b-eba7-4115-bca4-065669454fbf",
              "name": "TabelaMemoria",
              "value": "=memory_{{ $('dados mensagem').first().json.Instancia.toLowerCase() }}sdr",
              "type": "string"
            },
            {
              "id": "331df86c-9eaf-4a50-8b16-2cb51fcbeece",
              "name": "TabelaBC",
              "value": "=bc{{ $('dados mensagem').item.json.Instancia.toLowerCase() }}sdr",
              "type": "string"
            },
            {
              "id": "e879d7ba-2f03-4ba0-8837-efd2cbcf9ce6",
              "name": "TabelaFluxo",
              "value": "={{ $('dados mensagem').item.json.Instancia.toLowerCase() }}_regras_fluxo",
              "type": "string"
            },
            {
              "id": "3ba2dbe7-1f8e-4875-bcdd-9fe9d9231593",
              "name": "TelefoneAvisos",
              "value": "5481590037",
              "type": "string"
            },
            {
              "id": "f4802a8d-7cf7-4204-9adb-e124ed5618aa",
              "name": "FluxoAgendamentos",
              "value": "=https://webhook.eduardofischborn.com.br/webhook/lembretechatbotsdr{{ $('dados mensagem').first().json.Instancia.toLowerCase() }}",
              "type": "string"
            },
            {
              "id": "d668833a-decd-4948-9368-8b44153869b2",
              "name": "evolution_url",
              "value": "https://evolutionapi.eduardofischborn.com.br/",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -5232,
        -1280
      ],
      "id": "5d3e601f-c3a9-4f3d-b092-7607c68d2fe0",
      "name": "dados base"
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "={{ $('dados base').first().json.TabelaLeads }}",
        "filters": {
          "conditions": [
            {
              "keyName": "whatsapp",
              "condition": "eq",
              "keyValue": "={{ $('dados mensagem').first().json.Whatsapp }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "estado_atual",
              "fieldValue": "={{ $('puxa regras').last().json.nome_estado }}"
            }
          ]
        }
      },
      "id": "03ecca23-e734-4400-8290-01cc9211f65a",
      "name": "atualiza state",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -5984,
        -240
      ],
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "ICRwXhZLBgxPMEhm",
          "name": "[1] SUPABASE"
        }
      }
    },
    {
      "parameters": {
        "content": "## FERRAMENTAS",
        "height": 397,
        "width": 332
      },
      "id": "689d2776-5da1-4cef-a4c3-160442ef0959",
      "name": "Sticky Note10",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -4864,
        -896
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "22cc7982-57e2-4077-9382-b04ae9ea0ac9",
              "leftValue": "={{ $('puxa regras').last().json.ferramentas }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "empty",
                "singleValue": true
              }
            },
            {
              "id": "156a8009-1bfe-4a05-a148-ca1f4bd47ffb",
              "leftValue": "={{ $('puxa regras').last().json.ferramentas }}",
              "rightValue": "vazio",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -4832,
        -832
      ],
      "id": "d96e7a22-c910-4fcc-8cf4-a293484ab820",
      "name": "verifica ferramenta"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://webhook{{ $('puxa agente').first().json.servidor }}.{{ $('puxa agente').first().json.dominio }}/webhook/chatbottools{{ $('dados mensagem').first().json.Instancia.toLowerCase() }}",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "tool",
              "value": "={{ $('puxa regras').last().json.ferramentas }}"
            },
            {
              "name": "sessionid",
              "value": "={{ $('recebe dados').first().json.body.Whatsapp }}"
            },
            {
              "name": "instancia",
              "value": "={{ $('recebe dados').first().json.body.Instancia }}"
            },
            {
              "name": "execution",
              "value": "={{$execution.id}}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -4832,
        -672
      ],
      "id": "b602c101-5b78-4eed-b216-b975c1432a78",
      "name": "usa ferramenta",
      "retryOnFail": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "toolDescription": "=Use esta ferramenta apenas e exclusivamente para criar o evento final na agenda e enviar o convite, após o cliente ter confirmado um horário específico. Esta é a ação final do processo de agendamento e não deve ser usada para consultas ou verificações.\n\nParâmetros:\nhorario_confirmado_iso (Obrigatório):\nDescrição: \"A data e hora exatas e confirmadas para o agendamento, obrigatoriamente em formato ISO 8601 (ex: '2025-06-24T15:30:00-03:00').\"\n\nGuia para a IA:\n\"Use o valor do campo horario_confirmado_iso que a ferramenta gerenciar_agenda retornou quando a verificação de um horário foi bem-sucedida. Não use texto em linguagem natural aqui como 'amanhã às 15h'. Este campo exige precisão absoluta para que o evento seja criado no lugar certo.\"\n\n# IMPORTANTE: Todo os horários serão para o ano de 2025.",
        "method": "POST",
        "url": "=https://webhook{{ $('puxa agente').first().json.servidor }}.{{ $('puxa agente').first().json.dominio }}/webhook/sdrtoolcriarevento{{ $('dados mensagem').first().json.Instancia.toLowerCase() }}",
        "sendBody": true,
        "parametersBody": {
          "values": [
            {
              "name": "horario_confirmado_iso",
              "valueProvider": "modelOptional"
            },
            {
              "name": "SessionID",
              "valueProvider": "fieldValue",
              "value": "={{ $('dados mensagem').first().json.Whatsapp }}"
            },
            {
              "name": "Instancia",
              "valueProvider": "fieldValue",
              "value": "={{ $('dados mensagem').first().json.Instancia }}"
            },
            {
              "name": "intervalo_eventos",
              "valueProvider": "fieldValue",
              "value": "={{ $('puxa agente').first().json.duracao_agendamento }}"
            },
            {
              "name": "TelefoneAvisos",
              "valueProvider": "fieldValue",
              "value": "={{ $('puxa agente').first().json.telefone_avisos }}"
            },
            {
              "name": "FluxoAgendamentos",
              "valueProvider": "fieldValue",
              "value": "=https://webhook{{ $('puxa agente').first().json.servidor }}.{{ $('puxa agente').first().json.dominio }}/webhook/lembretechatbotsdr{{ $('recebe dados').first().json.body.Instancia.toLowerCase() }}"
            },
            {
              "name": "ResumoConversa",
              "valueProvider": "fieldValue",
              "value": "={{ $('concatena memoria').first().json.conversa_concatenada }}"
            },
            {
              "name": "execution",
              "valueProvider": "fieldValue",
              "value": "={{$execution.id}}"
            }
          ]
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
      "typeVersion": 1.1,
      "position": [
        -3824,
        -848
      ],
      "id": "acf36a46-9dcd-4e92-9531-c48e3f070033",
      "name": "criar_evento"
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "={{ $('dados base').first().json.TabelaLeads }}",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "whatsapp",
              "condition": "eq",
              "keyValue": "={{ $('dados mensagem').first().json.Whatsapp }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "log",
              "fieldValue": "={{ $('dados mensagem').first().json.log }}\n\n<bloco> ############\n- Nº Execução: {{$execution.id}}\n\n- Usuário: \n{{ $('agrupa mensagens').first().json.MensagensAgrupadas }}\n\n- Resposta IA: \n{{ $('AI Agent').first().json.output }}\n\n- Dados:\n{{ $('atualiza dados').first().json.dados }}\n\n- Pensamento IA: \n{{ $json.pensamentos_concatenados }}\n</bloco> ############"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -5536,
        -32
      ],
      "id": "8b7f0512-794b-41e7-bec8-233390ffd7fa",
      "name": "atualiza log",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "ICRwXhZLBgxPMEhm",
          "name": "[1] SUPABASE"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "agentes",
        "filters": {
          "conditions": [
            {
              "keyName": "cliente",
              "keyValue": "={{ $('dados mensagem').first().json.Instancia }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -5104,
        -1280
      ],
      "id": "4eeb4c1a-aeb0-448d-97e8-f88c0c02771a",
      "name": "puxa agente",
      "credentials": {
        "supabaseApi": {
          "id": "ICRwXhZLBgxPMEhm",
          "name": "[1] SUPABASE"
        }
      }
    },
    {
      "parameters": {
        "model": "text-embedding-3-large",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.1,
      "position": [
        -4368,
        -544
      ],
      "id": "c0171bac-7456-4375-ad77-63e2f28b17e3",
      "name": "gpt3",
      "credentials": {
        "openAiApi": {
          "id": "nIAJKQcNsxgZl09A",
          "name": "[KRUGER] OPENAI"
        }
      }
    },
    {
      "parameters": {
        "model": "gpt-4.1-mini",
        "options": {}
      },
      "id": "607aff62-4190-4bfd-8df0-fda3f3fd0639",
      "name": "gpt4",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [
        -3984,
        -576
      ],
      "credentials": {
        "openAiApi": {
          "id": "nIAJKQcNsxgZl09A",
          "name": "[KRUGER] OPENAI"
        }
      }
    },
    {
      "parameters": {
        "model": "gpt-4.1",
        "options": {}
      },
      "id": "33863304-59f5-451b-9319-84307f4f1368",
      "name": "gpt5",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [
        -3936,
        -848
      ],
      "credentials": {
        "openAiApi": {
          "id": "nIAJKQcNsxgZl09A",
          "name": "[KRUGER] OPENAI"
        }
      }
    },
    {
      "parameters": {
        "model": "gpt-4.1-mini",
        "options": {
          "temperature": 0.3
        }
      },
      "id": "89fe401f-b435-496f-bf3f-f6268f33afd6",
      "name": "gpt6",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [
        -5104,
        -192
      ],
      "credentials": {
        "openAiApi": {
          "id": "nIAJKQcNsxgZl09A",
          "name": "[KRUGER] OPENAI"
        }
      }
    },
    {
      "parameters": {
        "model": "gpt-4.1-mini",
        "options": {
          "temperature": 0.3
        }
      },
      "id": "9e90edb7-f4c6-4f8a-b4d7-037f8cce9f96",
      "name": "gpt7",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [
        -5088,
        144
      ],
      "credentials": {
        "openAiApi": {
          "id": "nIAJKQcNsxgZl09A",
          "name": "[KRUGER] OPENAI"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "=Nº execucao: {{$execution.id}}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -5776,
        -1280
      ],
      "id": "6ed801c9-1f96-4377-b4e7-3324646a861d",
      "name": "responde zap"
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "logs",
        "filters": {
          "conditions": [
            {
              "keyName": "whatsapp",
              "keyValue": "={{ $('dados mensagem').first().json.Whatsapp }}"
            },
            {
              "keyName": "cliente",
              "keyValue": "={{ $('dados mensagem').first().json.Instancia }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -5984,
        -32
      ],
      "id": "5e2ef1b4-62d2-4c03-98a5-eb5f06ac7d3e",
      "name": "puxa log",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "ICRwXhZLBgxPMEhm",
          "name": "[1] SUPABASE"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "let resultadoFinal = '';\nlet contador = 1;\n\nfor (const item of $input.all()) {\n  try {\n    const logBruto = item.json?.log;\n\n    if (!logBruto || typeof logBruto !== 'string' || logBruto.trim() === '') {\n      continue;\n    }\n\n    let logFormatado = logBruto;\n\n    if (logBruto.trim().startsWith('{') || logBruto.trim().startsWith('```json')) {\n      const match = logBruto.match(/\"pensamento\"\\s*:\\s*\"([\\s\\S]*?)\"\\s*}/);\n      if (match && match[1]) {\n        logFormatado = match[1].replace(/\\\\\"/g, '\"'); // remove escape\n      }\n    }\n\n    resultadoFinal += `==============================\\n`;\n    resultadoFinal += `Pensamento ${contador}\\n`;\n    resultadoFinal += `------------------------------\\n`;\n    resultadoFinal += `${logFormatado.trim()}\\n\\n`;\n\n    contador++;\n  } catch (erro) {\n    resultadoFinal += `==============================\\n`;\n    resultadoFinal += `Pensamento ${contador}\\n`;\n    resultadoFinal += `------------------------------\\n`;\n    resultadoFinal += `[Erro ao processar este log]\\n\\n`;\n    contador++;\n  }\n}\n\nreturn [\n  {\n    json: {\n      pensamentos_concatenados: resultadoFinal.trim() || 'Nenhum pensamento disponível.'\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -5680,
        -32
      ],
      "id": "96b6739e-10f4-4dec-9f2b-0b8d0009eabb",
      "name": "concatena logs",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "delete",
        "tableId": "logs",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "cliente",
              "condition": "eq",
              "keyValue": "={{ $('dados mensagem').first().json.Instancia }}"
            },
            {
              "keyName": "whatsapp",
              "condition": "eq",
              "keyValue": "={{ $('dados mensagem').first().json.Whatsapp }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -4832,
        -1280
      ],
      "id": "eadf9e3a-8c87-472b-bed0-6a2b20c36fc7",
      "name": "deleta logs temp",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "ICRwXhZLBgxPMEhm",
          "name": "[1] SUPABASE"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "delete",
        "tableId": "loops",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "whatsapp",
              "condition": "eq",
              "keyValue": "={{ $('dados mensagem').first().json.Whatsapp }}"
            },
            {
              "keyName": "cliente",
              "condition": "eq",
              "keyValue": "={{ $('dados mensagem').first().json.Instancia }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -4976,
        -1280
      ],
      "id": "a4447426-34ab-45dd-9edf-6c2c9bcfc8f4",
      "name": "apaga loops",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "ICRwXhZLBgxPMEhm",
          "name": "[1] SUPABASE"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "={{ $('dados base').first().json.TabelaMemoria }}",
        "returnAll": true,
        "filters": {
          "conditions": [
            {
              "keyName": "session_id",
              "condition": "eq",
              "keyValue": "={{ $('recebe dados').first().json.body.Whatsapp }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -5712,
        -896
      ],
      "id": "e40c443b-c269-401f-b0c0-258b492d2b78",
      "name": "puxa memoria",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "ICRwXhZLBgxPMEhm",
          "name": "[1] SUPABASE"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// 1. Acessa todos os itens que chegam no nó.\nconst items = $input.all();\n\n// 2. Ordena os itens com base no campo 'id' para garantir a ordem cronológica.\n// Se a sua ordenação depender de outro campo (como um de data), ajuste 'a.json.id - b.json.id'.\nitems.sort((a, b) => a.json.id - b.json.id);\n\n// 3. Cria um array para armazenar cada linha do diálogo.\nconst conversationHistory = [];\n\n// 4. Itera sobre cada item já ordenado.\nfor (const item of items) {\n  const message = item.json.message;\n\n  // Verifica se o objeto de mensagem existe e tem tipo e conteúdo.\n  if (message && message.type && message.content) {\n    let speaker;\n    if (message.type === 'human') {\n      speaker = 'Humano';\n    } else if (message.type === 'ai') {\n      speaker = 'IA';\n    } else {\n      speaker = message.type; // Caso haja outros tipos\n    }\n\n    // Adiciona a fala formatada ao histórico.\n    // O .trim() remove espaços em branco extras do início e fim do conteúdo.\n    conversationHistory.push(`${speaker}: ${message.content.trim()}`);\n  }\n}\n\n// 5. Junta todo o histórico em um único texto, com as mensagens separadas por duas quebras de linha.\nconst fullConversation = conversationHistory.join('\\n\\n');\n\n// 6. Retorna um único item contendo a conversa completa.\n// O próximo nó poderá acessar este texto usando a referência: {{ $json.conversa_concatenada }}\nreturn [{\n  json: {\n    conversa_concatenada: fullConversation\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -5552,
        -896
      ],
      "id": "834f4ac2-4573-43b4-9180-fb3903cc6aab",
      "name": "concatena memoria"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('puxa agente').first().json.fluxo_matriz }}\n\n# CONTEXTO PARA SUA ANÁLISE ATUAL\n## 1. DADOS JÁ COLETADOS SOBRE O CLIENTE:\n{{ $('atualiza dados').first().json.dados }}\n\n## 2. CHAVE DE VALIDAÇÃO DO ESTADO ATUAL (O OBJETIVO EXPLÍCITO):\n* `{{ $json.dados }}`: ({{ $json.dado_tipo }}) {{ $json.dado_descricao }}\n\n## 3. HISTÓRICO DA CONVERSA:\n<conversa>  \n{{ $('concatena memoria').first().json.conversa_concatenada }}\n</conversa>  \n<ultima_mensagem_cliente>  \n{{ $('agrupa mensagens').first().json.MensagensAgrupadas }}  \n</ultima_mensagem_cliente>\n\n## 4. MISSÃO DO ESTADO ATUAL (OBJETIVO A SER VALIDADO):\n\"{{ $json.missao_prompt }}\"\n\n## 5. OPÇÕES DE ROTA DISPONÍVEIS (CATEGORIZADAS):\n{{ $json.rotas_disponiveis }}\n\n# SEU OUTPUT (SEGUINDO A ESTRUTURA E O ALGORITMO):\n{\n  \"pensamento\": \"seu pensamento\",\n  \"estado_escolhido\": \"ESTADO_ESCOLHIDO\"\n}",
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        -5408,
        -736
      ],
      "id": "208814d8-b487-495b-8408-60905ff06c96",
      "name": "escolhe state"
    },
    {
      "parameters": {
        "jsCode": "// Este código irá inspecionar os dados de entrada para encontrar o texto da IA,\n// extrair o objeto JSON de dentro dele, e prepará-lo para os próximos nós.\n\nconst items = [];\n\n// Itera sobre cada item que chega do nó anterior (AI Agent).\nfor (const item of $input.all()) {\n  \n  // --- PASSO DE DIAGNÓSTICO ---\n  // Este comando imprime a estrutura exata do seu dado no console do seu navegador.\n  // Para ver o resultado: Execute o nó, aperte F12 no seu navegador, e clique na aba \"Console\".\n  console.log(\"ESTRUTURA COMPLETA DO ITEM DE ENTRADA:\", JSON.stringify(item, null, 2));\n\n  let rawText = null;\n\n  // --- TENTATIVA DE EXTRAÇÃO AUTOMÁTICA ---\n  // O código tentará encontrar o texto nos campos mais comuns onde a IA coloca sua resposta.\n  if (item.json.text) {\n    rawText = item.json.text;\n  } else if (item.json.output) {\n    rawText = item.json.output;\n  } else if (item.json.message) {\n    rawText = item.json.message;\n  } else if (item.json.response) {\n    rawText = item.json.response;\n  }\n  // Se o seu campo tiver outro nome, você pode adicioná-lo aqui. ex: else if (item.json.meu_campo)\n\n  // Se o texto foi encontrado, tenta fazer o parse do JSON.\n  if (rawText) {\n    try {\n      // Encontra o início '{' e o fim '}' do objeto JSON na string.\n      const firstBraceIndex = rawText.indexOf('{');\n      const lastBraceIndex = rawText.lastIndexOf('}');\n\n      if (firstBraceIndex === -1 || lastBraceIndex === -1) {\n        throw new Error(\"Não foi encontrado um objeto JSON válido (com '{' e '}') no texto.\");\n      }\n\n      // Extrai apenas a substring que contém o JSON.\n      const jsonString = rawText.substring(firstBraceIndex, lastBraceIndex + 1);\n      \n      // \"Parseia\" a string para criar um objeto JavaScript real.\n      const parsedJson = JSON.parse(jsonString);\n\n      // Adiciona o JSON limpo como um novo campo para ser usado nos próximos nós.\n      item.json.parsedOutput = parsedJson;\n\n    } catch (error) {\n      // Se o parsing falhar, adiciona informações de erro para depuração.\n      item.json.parsingError = true;\n      item.json.errorDetails = error.message;\n      item.json.rawOutputForDebug = rawText;\n    }\n  } else {\n    item.json.parsingError = true;\n    item.json.errorDetails = \"Não foi possível encontrar o campo de texto da IA no item de entrada. Verifique o console.log para ver a estrutura.\";\n  }\n  \n  items.push(item);\n}\n\n// Retorna os itens, agora com o campo 'parsedOutput' (ou com informações de erro).\nreturn items;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -5072,
        -736
      ],
      "id": "346174ae-25df-4950-936e-017bb45c480e",
      "name": "extrai state"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('puxa agente').first().json.extracao_dados }}\n\n# LISTA DE ENTIDADES PARA EXTRAIR (SEU DICIONÁRIO)\nVocê deve procurar pelas seguintes informações no texto do cliente:\n\n{{ $('junta dados').first().json.lista_campos }}\n\n# CONVERSA PARA ANÁLISE:\n\n<conversa> \n{{ $json.conversa_concatenada }}\n</conversa>\n\n<ultima_mensagem_cliente>\n\"{{ $('agrupa mensagens').first().json.MensagensAgrupadas }}\"\n</ultima_mensagem_cliente>\n\n# SEU OBJETO JSON DE ENTIDADES:",
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        -5408,
        -896
      ],
      "id": "4a87a539-a423-4afb-a086-56cd52637819",
      "name": "extrai dados"
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "={{ $('dados base').first().json.TabelaLeads }}",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "whatsapp",
              "condition": "eq",
              "keyValue": "={{ $('dados mensagem').first().json.Whatsapp }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "dados",
              "fieldValue": "={{ $json.dados_coletados_atualizados }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -5856,
        -736
      ],
      "id": "4566d405-6ff1-4a8c-acff-95186fe84f8a",
      "name": "atualiza dados",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "ICRwXhZLBgxPMEhm",
          "name": "[1] SUPABASE"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "55a6d3bf-7b36-4ee4-8f9b-a628dca848e5",
              "name": "extracao",
              "value": "={{ $json.text }}",
              "type": "string"
            },
            {
              "id": "f2196101-32fb-473b-9736-2c9f90e555d2",
              "name": "dados",
              "value": "={{ $('dados mensagem').first().json.dados }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -5072,
        -896
      ],
      "id": "ab7b7ce1-b8bc-4a7c-b7a4-3f877a1f92fb",
      "name": "dados extracao"
    },
    {
      "parameters": {
        "jsCode": "// VERSÃO DEFINITIVA - Gerenciador de Memória Robusto para Strings\n\n// Pega o item único de entrada.\nconst item = $input.first().json;\n\n// --- 1. Processamento Seguro dos Dados Antigos ('dados') ---\nlet dadosAntigos = {}; // Inicia como objeto vazio por padrão.\nconst dadosAntigosInput = item.dados;\n\n// Verifica se 'dados' existe e é uma string não vazia.\nif (dadosAntigosInput && typeof dadosAntigosInput === 'string') {\n  try {\n    // Tenta fazer o \"parse\" da string JSON que veio do Supabase.\n    dadosAntigos = JSON.parse(dadosAntigosInput);\n    \n    // Garante que o resultado do parse é realmente um objeto e não outra coisa.\n    if (typeof dadosAntigos !== 'object' || dadosAntigos === null) {\n        dadosAntigos = {};\n    }\n  } catch (error) {\n    console.log(\"AVISO: O campo 'dados' não era um JSON válido. Tratando como vazio.\", error.message);\n    dadosAntigos = {};\n  }\n} else if (dadosAntigosInput && typeof dadosAntigosInput === 'object') {\n    // Se, por acaso, o n8n já o converteu para um objeto, apenas o usamos.\n    dadosAntigos = dadosAntigosInput;\n}\n\n// --- 2. Limpeza e Parse dos Dados Novos ('extracao') ---\nlet dadosNovos = {}; // Inicia como objeto vazio por segurança.\nconst novosDadosComoString = item.extracao;\n\n// Só executa se 'extracao' for uma string não vazia.\nif (novosDadosComoString && typeof novosDadosComoString === 'string') {\n  try {\n    // Encontra o primeiro '{' e o último '}' para isolar o JSON puro.\n    const inicioJson = novosDadosComoString.indexOf('{');\n    const fimJson = novosDadosComoString.lastIndexOf('}');\n    \n    if (inicioJson === -1 || fimJson === -1) {\n      throw new Error(\"Não foi encontrado um JSON válido dentro da string 'extracao'.\");\n    }\n    \n    const jsonPuroString = novosDadosComoString.substring(inicioJson, fimJson + 1);\n\n    // Faz o parse da string JSON já limpa.\n    dadosNovos = JSON.parse(jsonPuroString);\n  } catch (error) {\n    console.log(\"AVISO: Falha ao extrair ou parsear o JSON da string 'extracao'.\", error.message);\n  }\n}\n\n// --- 3. Fusão (Merge) Dinâmica dos Dados ---\n// Junta os dados antigos com os novos.\nconst memoriaAtualizada = { ...dadosAntigos, ...dadosNovos };\n\n// --- 4. Saída ---\n// Retorna o resultado final.\nreturn [{\n  json: {\n    dados_coletados_atualizados: memoriaAtualizada\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -6000,
        -736
      ],
      "id": "8d0a675f-ff70-4436-bbf7-0bc996041afd",
      "name": "concatena dados"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "ea15a714-75ef-4ae0-9fd3-29e8885f8907",
              "leftValue": "={{ $('puxa regras').item.json.nome_estado }}",
              "rightValue": "={{ $('extrai state').item.json.parsedOutput.estado_escolhido }}",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -5696,
        -592
      ],
      "id": "4027da08-b1dc-4415-9f3f-72673a7ccc9c",
      "name": "avalia state"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "={{ $('dados base').first().json.TabelaFluxo }}",
        "returnAll": true,
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "nome_estado",
              "condition": "eq",
              "keyValue": "={{ $json.estado_atual }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -5552,
        -736
      ],
      "id": "aa2790ce-0ba8-469b-8cc6-15e0471a1e9c",
      "name": "puxa regras",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "ICRwXhZLBgxPMEhm",
          "name": "[1] SUPABASE"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d09b329e-f489-4570-9701-605beb266260",
              "name": "estado_atual",
              "value": "={{ $('extrai state').item.json.parsedOutput.estado_escolhido }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -5712,
        -736
      ],
      "id": "a75ada4c-62a4-4435-b0f6-5b83e2e1ced4",
      "name": "novo state"
    },
    {
      "parameters": {
        "model": "gpt-4.1",
        "options": {}
      },
      "id": "e9846d58-f703-427d-9bdc-1946bf331a80",
      "name": "gpt1",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [
        -5296,
        -784
      ],
      "credentials": {
        "openAiApi": {
          "id": "nIAJKQcNsxgZl09A",
          "name": "[KRUGER] OPENAI"
        }
      }
    },
    {
      "parameters": {
        "model": "gpt-4.1-mini",
        "options": {}
      },
      "id": "d3beea35-3a08-489a-939d-110929456b80",
      "name": "gpt2",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [
        -5056,
        -560
      ],
      "credentials": {
        "openAiApi": {
          "id": "nIAJKQcNsxgZl09A",
          "name": "[KRUGER] OPENAI"
        }
      }
    },
    {
      "parameters": {
        "tableId": "logs",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "log",
              "fieldValue": "=- Estado atual: {{ $('puxa regras').item.json.nome_estado }}\n\n{{ $('escolhe state').first().json.text }}\n"
            },
            {
              "fieldId": "whatsapp",
              "fieldValue": "={{ $('dados mensagem').first().json.Whatsapp }}"
            },
            {
              "fieldId": "cliente",
              "fieldValue": "={{ $('dados mensagem').first().json.Instancia }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -6000,
        -592
      ],
      "id": "aea60735-7d7f-46be-962d-8048dc5aa302",
      "name": "cria log",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "ICRwXhZLBgxPMEhm",
          "name": "[1] SUPABASE"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "de5f554b-0d04-41c6-a382-d7940efbe7f5",
              "leftValue": "={{ $json.count_id }}",
              "rightValue": 10,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -5232,
        -592
      ],
      "id": "07961ae2-1507-4471-9c91-bc48382a95c9",
      "name": "avalia loop"
    },
    {
      "parameters": {
        "tableId": "loops",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "loop",
              "fieldValue": "=1"
            },
            {
              "fieldId": "whatsapp",
              "fieldValue": "={{ $('dados mensagem').first().json.Whatsapp }}"
            },
            {
              "fieldId": "cliente",
              "fieldValue": "={{ $('dados mensagem').first().json.Instancia }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -5856,
        -592
      ],
      "id": "260d254b-aa45-4a29-a416-eb8bca385bcd",
      "name": "cria loop",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "ICRwXhZLBgxPMEhm",
          "name": "[1] SUPABASE"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "loops",
        "filters": {
          "conditions": [
            {
              "keyName": "whatsapp",
              "keyValue": "={{ $('dados mensagem').first().json.Whatsapp }}"
            },
            {
              "keyName": "cliente",
              "keyValue": "={{ $('dados mensagem').first().json.Instancia }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -5552,
        -592
      ],
      "id": "f3d9006b-5518-48c6-8e85-5099f2675fc2",
      "name": "puxa loops",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "ICRwXhZLBgxPMEhm",
          "name": "[1] SUPABASE"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "fieldsToSummarize": {
          "values": [
            {
              "field": "id"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.summarize",
      "typeVersion": 1.1,
      "position": [
        -5392,
        -592
      ],
      "id": "fff5caac-d8fc-4b93-b31e-a891fedefdf5",
      "name": "conta loops"
    },
    {
      "parameters": {
        "sortFieldsUi": {
          "sortField": [
            {
              "fieldName": "id"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.sort",
      "typeVersion": 1,
      "position": [
        -5840,
        -32
      ],
      "id": "9e660eb2-cb91-4302-913b-d18cc900d658",
      "name": "ordena logs",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// -----------------------------------------------------------------------------\n// Junta campos e formata em lista markdown\n// -----------------------------------------------------------------------------\n\n// 1) Pega todos os itens de entrada\nconst inputItems = $input.all();\n\n// 2) Guarda cada linha já no formato desejado\nconst lines = [];\n\nfor (const item of inputItems) {\n\t// Extrai apenas os 3 campos de interesse\n\tconst { dados, dado_descricao, dado_tipo } = item.json;\n\n\t// 3) Pula se o campo 'dados' estiver vazio, null ou for a palavra \"vazio\"\n\tif (!dados || String(dados).trim().toLowerCase() === 'vazio') continue;\n\n\t// 4) Monta a linha já formatada\n\t//    Ex.: * `dificuldade_vendas`: (string) Qual é a dificuldade …\n\tlines.push(`* \\`${dados}\\`: (${dado_tipo}) ${dado_descricao}`);\n}\n\n// 5) Concatena tudo em uma única string separada por quebras de linha\nconst listaFormatada = lines.join('\\n');\n\n// 6) Devolve um único item com o resultado\nreturn [\n\t{\n\t\tjson: {\n\t\t\tlista_campos: listaFormatada,\n\t\t},\n\t},\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -5856,
        -896
      ],
      "id": "c10cd681-a823-4764-b9b5-e9e44f4c58f3",
      "name": "junta dados"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "={{ $('dados base').first().json.TabelaFluxo }}",
        "returnAll": true,
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "gt",
              "keyValue": "=0"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -6000,
        -896
      ],
      "id": "de2e6244-1f59-4700-b24c-e7adbaf9cb2c",
      "name": "puxa dados",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "ICRwXhZLBgxPMEhm",
          "name": "[1] SUPABASE"
        }
      }
    },
    {
      "parameters": {
        "fieldsToAggregate": {
          "fieldToAggregate": [
            {}
          ]
        },
        "options": {}
      },
      "id": "1c141acf-9576-4471-9b8b-99bba888e7a3",
      "name": "zera",
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        -4400,
        96
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "22cc7982-57e2-4077-9382-b04ae9ea0ac9",
              "leftValue": "={{ $('puxa regras').last().json.midia }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "empty",
                "singleValue": true
              }
            },
            {
              "id": "156a8009-1bfe-4a05-a148-ca1f4bd47ffb",
              "leftValue": "={{ $('puxa regras').last().json.midia }}",
              "rightValue": "vazio",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -4192,
        96
      ],
      "id": "d5bec17f-dd87-45cd-94e8-3a934e9fa2a0",
      "name": "verifica midia"
    },
    {
      "parameters": {
        "url": "=https://drive.google.com/uc?export=download&id={{ $('puxa regras').last().json.midia }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -4032,
        96
      ],
      "id": "b510a161-2d8e-4888-bcc2-4f91376c1191",
      "name": "puxa midia",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('dados base').first().json.evolution_url }}message/sendMedia/{{ $('dados mensagem').first().json.Instancia }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "=55{{ $('recebe dados').first().json.body.Whatsapp }}"
            },
            {
              "name": "media",
              "value": "={{ $('extrai tipo').first().json.media }}"
            },
            {
              "name": "presence",
              "value": "composing"
            },
            {
              "name": "linkPreview",
              "value": "={{ false }}"
            },
            {
              "name": "delay",
              "value": "={{ 2500 }}"
            },
            {
              "name": "mediatype",
              "value": "={{ $('extrai tipo').first().json.mediatype }}"
            }
          ]
        },
        "options": {}
      },
      "id": "611ba382-a8e6-4909-aab2-755d95979f76",
      "name": "envia midia",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -3632,
        96
      ],
      "executeOnce": true,
      "credentials": {
        "httpHeaderAuth": {
          "id": "rPARANITH2QYrjl5",
          "name": "[1] EVOLUTION"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// Puxa o MIME type do node \"puxa midia\"\nconst mimeType = $node[\"puxa midia\"].binary.data.mimeType;\n\n// Define o tipo geral aceito pela API\nlet mediatype = '';\nif (mimeType.startsWith('image/')) {\n  mediatype = 'image';\n} else if (mimeType.startsWith('video/')) {\n  mediatype = 'video';\n} else if (mimeType.startsWith('audio/')) {\n  mediatype = 'audio';\n} else {\n  mediatype = 'document'; // fallback\n}\n\n// Pega o base64 gerado pelo node \"midia pra base64\"\nconst base64Content = $node[\"midia pra base64\"].json.data;\n\n// Retorna estrutura correta\nreturn [\n  {\n    json: {\n      mediatype,\n      media: base64Content,\n    },\n  },\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3760,
        96
      ],
      "id": "f7467a69-f8fb-4803-85c8-5afa291fc0ad",
      "name": "extrai tipo"
    },
    {
      "parameters": {
        "operation": "binaryToPropery",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        -3888,
        96
      ],
      "id": "479d60a1-328f-460c-bf6f-4f22dd5b4432",
      "name": "midia pra base64"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "e0c76d6a-3835-43ea-9906-3b9dd701697c",
              "leftValue": "={{ $('recebe dados').first().json.body.midia }}",
              "rightValue": "audio",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -4256,
        -240
      ],
      "id": "e10734a5-9418-4769-9534-8f689337459d",
      "name": "audio ou texto"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.elevenlabs.io/v1/text-to-speech/{{ $('puxa agente').first().json.voz }}",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "output_format",
              "value": "mp3_44100_128"
            }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "xi-api-key",
              "value": "={{ $('puxa agente').first().json.api_elevenlabs }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "text",
              "value": "={{ $('AI Agent').first().json.output }}"
            },
            {
              "name": "model_id",
              "value": "eleven_multilingual_v2"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -4096,
        -240
      ],
      "id": "8eadf0fd-6c31-48c0-b869-db798cb486fd",
      "name": "cria audio",
      "retryOnFail": true,
      "executeOnce": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('dados base').first().json.evolution_url }}message/sendWhatsAppAudio/{{ $('dados mensagem').first().json.Instancia }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "=55{{ $('recebe dados').first().json.body.Whatsapp }}"
            },
            {
              "name": "audio",
              "value": "={{ $json.data }}"
            },
            {
              "name": "linkPreview",
              "value": "={{ false }}"
            },
            {
              "name": "delay",
              "value": "={{ 2500 }}"
            }
          ]
        },
        "options": {}
      },
      "id": "04a6e7f4-161f-46ef-867a-41694b27bffb",
      "name": "envia audio zap",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -3808,
        -240
      ],
      "executeOnce": true,
      "credentials": {
        "httpHeaderAuth": {
          "id": "rPARANITH2QYrjl5",
          "name": "[1] EVOLUTION"
        }
      }
    },
    {
      "parameters": {
        "operation": "binaryToPropery",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        -3952,
        -240
      ],
      "id": "351ff42d-69e0-4ec5-b605-cb0240055ab4",
      "name": "base64 audio"
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "={{ $('dados base').first().json.TabelaTemp }}",
        "filters": {
          "conditions": [
            {
              "keyName": "whatsapp",
              "keyValue": "={{ $('dados mensagem').first().json.Whatsapp }}"
            }
          ]
        }
      },
      "id": "a3dcc47a-7e95-478e-9331-a7475f597fbb",
      "name": "puxa mensagens",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -4656,
        -1296
      ],
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "ICRwXhZLBgxPMEhm",
          "name": "[1] SUPABASE"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "3dbcdc93-3f2d-4b40-bd57-cb3819df7096",
              "leftValue": "={{ $json.id }}",
              "rightValue": "",
              "operator": {
                "type": "number",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "dfa95428-ecc0-4ffe-9290-7cf4f4fd6328",
      "name": "testa pra ver se ja tem msg",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -4480,
        -1296
      ]
    },
    {
      "parameters": {
        "tableId": "={{ $('dados base').first().json.TabelaTemp }}",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "whatsapp",
              "fieldValue": "={{ $('dados mensagem').first().json.Whatsapp }}"
            },
            {
              "fieldId": "nome_cliente",
              "fieldValue": "={{ $('dados mensagem').first().json.Nome }}"
            },
            {
              "fieldId": "data_mensagem",
              "fieldValue": "={{ $('dados mensagem').first().json.Data }}"
            },
            {
              "fieldId": "hora_mensagem",
              "fieldValue": "={{ $('dados mensagem').first().json.Horario }}"
            },
            {
              "fieldId": "texto_cliente",
              "fieldValue": "={{ $('dados mensagem').first().json.Mensagem }}"
            },
            {
              "fieldId": "primeira_mensagem",
              "fieldValue": "sim"
            }
          ]
        }
      },
      "id": "17f33c24-c636-41a7-b21e-bcf15156640f",
      "name": "salva primeira msg",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -4144,
        -1296
      ],
      "executeOnce": true,
      "credentials": {
        "supabaseApi": {
          "id": "ICRwXhZLBgxPMEhm",
          "name": "[1] SUPABASE"
        }
      }
    },
    {
      "parameters": {
        "tableId": "={{ $('dados base').first().json.TabelaTemp }}",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "whatsapp",
              "fieldValue": "={{ $('dados mensagem').first().json.Whatsapp }}"
            },
            {
              "fieldId": "nome_cliente",
              "fieldValue": "={{ $('dados mensagem').first().json.Nome }}"
            },
            {
              "fieldId": "data_mensagem",
              "fieldValue": "={{ $('dados mensagem').first().json.Data }}"
            },
            {
              "fieldId": "hora_mensagem",
              "fieldValue": "={{ $('dados mensagem').first().json.Horario }}"
            },
            {
              "fieldId": "texto_cliente",
              "fieldValue": "={{ $('dados mensagem').first().json.Mensagem }}"
            }
          ]
        }
      },
      "id": "7cc0a3ba-9b23-4cb0-8e06-d112ddfcd897",
      "name": "salva outras msgs",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -4304,
        -1296
      ],
      "executeOnce": true,
      "credentials": {
        "supabaseApi": {
          "id": "ICRwXhZLBgxPMEhm",
          "name": "[1] SUPABASE"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "={{ $('dados base').first().json.TabelaTemp }}",
        "filters": {
          "conditions": [
            {
              "keyName": "whatsapp",
              "keyValue": "={{ $('dados mensagem').first().json.Whatsapp }}"
            }
          ]
        }
      },
      "id": "04a727d0-849c-43cd-a9d8-fc193afeebc7",
      "name": "puxa mensagens1",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -4304,
        -1152
      ],
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "ICRwXhZLBgxPMEhm",
          "name": "[1] SUPABASE"
        }
      }
    },
    {
      "parameters": {
        "operation": "delete",
        "tableId": "={{ $('dados base').first().json.TabelaTemp }}",
        "filters": {
          "conditions": [
            {
              "keyName": "whatsapp",
              "condition": "eq",
              "keyValue": "={{ $('dados mensagem').first().json.Whatsapp }}"
            }
          ]
        }
      },
      "id": "70b0e39a-e04e-4f96-a2dd-0153bcb0eba7",
      "name": "apaga as msgs",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -3968,
        -1280
      ],
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "ICRwXhZLBgxPMEhm",
          "name": "[1] SUPABASE"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Inicializa uma variável para armazenar o texto concatenado\nlet concatenatedText = \"\";\n\n// Itera sobre todos os itens de entrada\nfor (const item of $input.all()) {\n  // Pega o texto de 'texto_cliente' para o item atual\n  const text = item.json.texto_cliente;\n\n  // Adiciona o texto ao concatenado, separado por espaço (ou outro delimitador, se preferir)\n  concatenatedText += (text ? text.trim() + \" \" : \"\");\n}\n\n// Remove qualquer espaço extra no final e retorna o texto concatenado\nreturn [{\n  json: {\n    MensagensAgrupadas: concatenatedText.trim() // Remove espaços extras ao final\n  }\n}];\n"
      },
      "id": "0f139337-d699-4629-9619-96dd775b6cb0",
      "name": "agrupa mensagens",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4144,
        -1152
      ]
    },
    {
      "parameters": {
        "content": "# CONCATENA MENSAGENS",
        "height": 378,
        "width": 831,
        "color": 5
      },
      "id": "b0902813-0ddc-4b46-93cb-28276dd34532",
      "name": "Sticky Note12",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -4688,
        -1376
      ],
      "disabled": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "834d765a-b7d6-4a47-9a2f-15afe71591f5",
              "leftValue": "={{ $('dados mensagem').first().json.Whatsapp }}",
              "rightValue": "5191539721",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "cbb35102-fcd4-449f-aaf7-b25738a73860",
              "leftValue": "={{ $('dados mensagem').first().json.Whatsapp }}",
              "rightValue": "=5497068821",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "b9ef156f-654b-42ec-adf9-b1e04182de08",
              "leftValue": "={{ $('dados mensagem').first().json.Whatsapp }}",
              "rightValue": "5184036335",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "d091ce37-b1a2-49e1-901e-223307ef3dbc",
              "leftValue": "={{ $('dados mensagem').first().json.Whatsapp }}",
              "rightValue": "5192280439",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "bfae7a1a-c46f-472c-bc11-0bfa97baf675",
              "leftValue": "={{ $('dados mensagem').first().json.Whatsapp }}",
              "rightValue": "5181427825",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -4656,
        -1152
      ],
      "id": "07cd08c5-903a-4589-b46e-919e69f0ac25",
      "name": "pula timer"
    },
    {
      "parameters": {
        "amount": "={{ $('puxa agente').first().json.delay }}"
      },
      "id": "031b53c3-a92d-472d-978d-2e705955bfca",
      "name": "delay",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -4480,
        -1152
      ],
      "webhookId": "fe6b7834-9fdc-4911-b19e-97c95b35872a"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://webhook{{ $('puxa agente').first().json.servidor }}.{{ $('puxa agente').first().json.dominio }}/webhook/chatbottools{{ $('dados mensagem').first().json.Instancia.toLowerCase() }}",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "sessionid",
              "value": "={{ $('recebe dados').first().json.body.Whatsapp }}"
            },
            {
              "name": "instancia",
              "value": "={{ $('recebe dados').first().json.body.Instancia }}"
            },
            {
              "name": "execution",
              "value": "={{$execution.id}}"
            },
            {
              "name": "crm",
              "value": "={{ $('puxa regras').last().json.crm }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -4672,
        -672
      ],
      "id": "f956714c-aaad-43df-9656-36dfb4e91be7",
      "name": "atualiza crm",
      "retryOnFail": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "22cc7982-57e2-4077-9382-b04ae9ea0ac9",
              "leftValue": "={{ $('puxa regras').last().json.crm }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "empty",
                "singleValue": true
              }
            },
            {
              "id": "156a8009-1bfe-4a05-a148-ca1f4bd47ffb",
              "leftValue": "={{ $('puxa regras').last().json.crm }}",
              "rightValue": "vazio",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "ff2e8ee9-0cd7-4a6e-b1d9-92f10c1cd132",
              "leftValue": "={{ $('puxa regras').last().json.crm }}",
              "rightValue": "crm_",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -4672,
        -832
      ],
      "id": "ed810b60-d6f3-41c9-a423-3883fb8a0a6e",
      "name": "verifica crm"
    },
    {
      "parameters": {
        "jsCode": "// Obter os dados de entrada (assumindo que estão no campo 'datetime')\nlet inputString = $now.toString(); // Garantir que é uma string\n\n// Função para retornar os 10 primeiros caracteres (data)\nfunction FirstTen(input) {\n    return input.substring(0, 10);\n}\n\n// Função para formatar a data no formato DIA/MÊS/ANO\nfunction FormatDateToDMY(input) {\n    const [year, month, day] = input.split('-');\n    return `${day}/${month}/${year}`;\n}\n\n// Função para retornar os caracteres de 11 a 19 (hora)\nfunction ElevenToNineteen(input) {\n    return input.substring(11, 19);\n}\n\n// Função para gerar timestamp ISO (até os segundos)\nfunction GetTimestampISO(input) {\n    return input.substring(0, 19);\n}\n\n// Manter os 19 primeiros caracteres\nconst HorarioEnvioMensagem = ElevenToNineteen(inputString);\nconst DataEnvioMensagem = FormatDateToDMY(FirstTen(inputString));\nconst TimestampISO = GetTimestampISO(inputString);\n\n// Retornar os resultados\nreturn {\n    json: {\n        horario_envio_mensagem: HorarioEnvioMensagem,\n        data_envio_mensagem: DataEnvioMensagem,\n        timestamp_iso: TimestampISO\n    }\n};\n"
      },
      "id": "d202f4b5-b9dc-4783-99ec-83a38a7dc05d",
      "name": "data hora",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -5504,
        -1280
      ]
    },
    {
      "parameters": {
        "dataToSave": {
          "values": [
            {
              "key": "whatsapp",
              "value": "={{ $json.body.Whatsapp }}"
            },
            {
              "key": "nome",
              "value": "={{ $json.body.Nome }}"
            },
            {
              "key": "estado",
              "value": "={{ $json.body.estado_atual }}"
            },
            {
              "key": "ferramenta",
              "value": "={{ $json.body.ferramentas }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executionData",
      "typeVersion": 1.1,
      "position": [
        -5632,
        -1280
      ],
      "id": "4a110581-b11d-4d89-ae2e-0e8e5619f999",
      "name": "highlight"
    },
    {
      "parameters": {
        "content": "## ÁUDIO - ELEVENLABS",
        "height": 258,
        "width": 680,
        "color": 6
      },
      "id": "4b8ff714-ab7d-4b25-a57f-071a879232cb",
      "name": "Sticky Note9",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -4304,
        -304
      ]
    },
    {
      "parameters": {
        "content": "## ENVIA MÍDIA",
        "height": 290,
        "width": 712,
        "color": 2
      },
      "id": "5138b23c-dbc0-42b0-ab62-5235de09a3a4",
      "name": "Sticky Note11",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -4224,
        16
      ]
    },
    {
      "parameters": {
        "tableId": "eventos",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "cliente",
              "fieldValue": "={{ $('recebe dados').first().json.body.Instancia }}"
            },
            {
              "fieldId": "fluxo",
              "fieldValue": "chatbot"
            },
            {
              "fieldId": "data",
              "fieldValue": "={{ $('data hora').first().json.data_envio_mensagem }}"
            },
            {
              "fieldId": "horario",
              "fieldValue": "={{ $('data hora').first().json.horario_envio_mensagem }}"
            },
            {
              "fieldId": "iso",
              "fieldValue": "={{ $('data hora').first().json.timestamp_iso }}"
            },
            {
              "fieldId": "origem",
              "fieldValue": "=whatsapp{{ $('dados mensagem').first().json.Whatsapp }}"
            },
            {
              "fieldId": "conteudo",
              "fieldValue": "=<bloco> ############\n- Nº Execução: {{$execution.id}}\n\n- Usuário: \n{{ $('agrupa mensagens').first().json.MensagensAgrupadas }}\n\n- Resposta IA: \n{{ $('AI Agent').first().json.output }}\n\n- Dados:\n{{ $('atualiza dados').first().json.dados }}\n\n- Pensamento IA: \n{{ $('concatena logs').first().json.pensamentos_concatenados }}\n</bloco> ############"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -3056,
        96
      ],
      "id": "c4ace50a-f6ea-4af1-95b8-56013082739f",
      "name": "evento completo",
      "credentials": {
        "supabaseApi": {
          "id": "ICRwXhZLBgxPMEhm",
          "name": "[1] SUPABASE"
        }
      }
    },
    {
      "parameters": {
        "toolDescription": "=Use esta ferramenta para QUALQUER consulta à agenda que NÃO SEJA criar o evento final. Ela pode verificar a disponibilidade de um horário específico que o cliente sugeriu, ou pode encontrar e sugerir novos horários livres quando o cliente não sabe ou não pode nos horários já oferecidos.\"\n\n# Parâmetros:\n## tipo_de_busca (Obrigatório):\nDescrição: \"Define a ação exata que você quer executar na agenda. Você deve escolher uma destas três opções de texto: 'verificar_especifico', 'sugerir_iniciais', ou 'sugerir_proximos'.\"\n\nGuia para a IA:\nUse 'verificar_especifico' quando o cliente sugerir um dia e hora exatos (ex: \"Podemos na terça às 15h?\").\n\nUse 'sugerir_iniciais' no começo do processo de agendamento, para ser proativo e oferecer os primeiros horários.\n\nUse 'sugerir_proximos' quando as sugestões anteriores não funcionaram e você precisa encontrar novas opções.\n\n## data:\nDescrição para a IA: \"A data que o cliente mencionou. Passe o texto original dele (ex: 'amanhã', 'na próxima quarta', 'dia 25', 'semana que vem', 'próximo mês').\" The date selected by the user. It can be expressed in various formats, including: - Day of the week: \"segunda\", \"terça-feira\", \"quarta\", \"sábado\". - Day and month: \"15/07\", \"13/04\". - Only the day (assumed to be in the current month): \"dia 20\", \"dia 13\", \"esse dia 14\". - Time expressions: \"amanhã\", \"depois de amanhã\", \"daqui a 3 dias\", \"mês que vem\", \"daqui 3 semanas\".\n\nSe você não localizar a data, envie o parâmetro como o texto \"vazio\".\n\n\n## horario:\nDescrição para a IA: \"A hora que o cliente mencionou. Passe o texto original dele (ex: 'pela manhã', 'umas 16h', '14:30').\"\nO horário também pode ser expresso de várias formas, incluindo: texto, números e expressões temporais.\n\nSe você não localizar o horário, envie o parâmetro como o texto \"vazio\".\n\n**Evite alterar o texto original do usuário**",
        "method": "POST",
        "url": "=https://webhook{{ $('puxa agente').first().json.servidor }}.{{ $('puxa agente').first().json.dominio }}/webhook/sdrtoolagenda{{ $('dados mensagem').first().json.Instancia.toLowerCase() }}",
        "sendBody": true,
        "parametersBody": {
          "values": [
            {
              "name": "data"
            },
            {
              "name": "horario"
            },
            {
              "name": "SessionID",
              "valueProvider": "fieldValue",
              "value": "={{ $('dados mensagem').first().json.Whatsapp }}"
            },
            {
              "name": "Instancia",
              "valueProvider": "fieldValue",
              "value": "={{ $('dados mensagem').first().json.Instancia }}"
            },
            {
              "name": "tipo_de_busca"
            },
            {
              "name": "execution",
              "valueProvider": "fieldValue",
              "value": "={{$execution.id}}"
            },
            {
              "name": "horarios_agendamentos",
              "valueProvider": "fieldValue",
              "value": "={{ $('puxa agente').first().json.horarios_agendamentos }}"
            },
            {
              "name": "tempo_previo_agendamento",
              "valueProvider": "fieldValue",
              "value": "={{ $('puxa agente').first().json.tempo_previo_agendamento }}"
            },
            {
              "name": "duracao_agendamento",
              "valueProvider": "fieldValue",
              "value": "={{ $('puxa agente').first().json.duracao_agendamento }}"
            }
          ]
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
      "typeVersion": 1.1,
      "position": [
        -3824,
        -720
      ],
      "id": "8dce4809-e5d0-4b53-987e-47aa8045b140",
      "name": "gerenciar_agenda"
    },
    {
      "parameters": {
        "toolDescription": "=Use essa ferramenta quando o usuário solicitar para desmarcar ou cancelar um agendamento/reunião/horário.",
        "method": "POST",
        "url": "=https://webhook{{ $('puxa agente').first().json.servidor }}.{{ $('puxa agente').first().json.dominio }}/webhook/sdrtoolapagarevento{{ $('dados mensagem').first().json.Instancia.toLowerCase() }}",
        "sendBody": true,
        "parametersBody": {
          "values": [
            {
              "name": "SessionID",
              "valueProvider": "fieldValue",
              "value": "={{ $('dados mensagem').first().json.Whatsapp }}"
            },
            {
              "name": "Instancia",
              "valueProvider": "fieldValue",
              "value": "={{ $('dados mensagem').first().json.Instancia }}"
            },
            {
              "name": "TelefoneAvisos",
              "valueProvider": "fieldValue",
              "value": "={{ $('puxa agente').first().json.telefone_avisos }}"
            },
            {
              "name": "FluxoAgendamentos",
              "valueProvider": "fieldValue",
              "value": "=https://webhook{{ $('puxa agente').first().json.servidor }}.{{ $('puxa agente').first().json.dominio }}/webhook/lembretechatbotsdr{{ $('recebe dados').first().json.body.Instancia.toLowerCase() }}"
            },
            {
              "name": "ResumoConversa",
              "valueProvider": "fieldValue",
              "value": "={{ $('concatena memoria').first().json.conversa_concatenada }}"
            },
            {
              "name": "execution",
              "valueProvider": "fieldValue",
              "value": "={{$execution.id}}"
            }
          ]
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
      "typeVersion": 1.1,
      "position": [
        -3824,
        -576
      ],
      "id": "9a874baf-cdd8-4665-a895-16e041b12d23",
      "name": "apagar_evento"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://app.agenteluna.com/api/1.1/obj/Mensagens",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer 709e60797d1f439e883dca96eeb0299a"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "cliente",
              "value": "={{ $('salva msg ia bubble').first().json.cliente }}"
            },
            {
              "name": "autor",
              "value": "={{ $('salva msg ia bubble').first().json.autor }}"
            },
            {
              "name": "conteudo",
              "value": "={{ $('salva msg ia bubble').first().json.conteudo }}"
            },
            {
              "name": "destino",
              "value": "={{ $('salva msg ia bubble').first().json.destino }}"
            },
            {
              "name": "hora_mensagem",
              "value": "={{ $('salva msg ia bubble').first().json.hora_mensagem }}"
            },
            {
              "name": "raciocinio_ia",
              "value": "={{ $('salva msg ia bubble').first().json.raciocinio_ia }}"
            },
            {
              "name": "whatsapp",
              "value": "={{ $('salva msg ia bubble').first().json.whatsapp }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -5536,
        -240
      ],
      "id": "18369642-2744-458f-a0d4-07b9319308ca",
      "name": "cria msg bubble ia",
      "alwaysOutputData": true,
      "executeOnce": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "content": "# Cuidar tag vermelha\n## É Personalização de cliente",
        "height": 128,
        "width": 448,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -6368,
        272
      ],
      "typeVersion": 1,
      "id": "88e92c4e-1c4f-4655-9c87-c70118445974",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "content": "# Versão 1.2.1",
        "height": 80,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3152,
        336
      ],
      "typeVersion": 1,
      "id": "23636a41-c4bc-45ce-8201-10afc1b0ab08",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "852cedd8-05a0-4fcf-a082-6a3b2dbe6754",
              "leftValue": "={{ $json.status }}",
              "rightValue": "off",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3360,
        -1376
      ],
      "id": "8a06549e-89d9-4198-9948-820b876bca1a",
      "name": "Status"
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "={{ $('dados base').first().json.TabelaLeads }}",
        "filters": {
          "conditions": [
            {
              "keyName": "whatsapp",
              "keyValue": "={{ $('dados mensagem').first().json.Whatsapp }}"
            }
          ]
        }
      },
      "id": "5f411b05-3312-45bc-9508-fc5cfc72a350",
      "name": "testa fone sem 9",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -3680,
        -1376
      ],
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "ICRwXhZLBgxPMEhm",
          "name": "[1] SUPABASE"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "4c7eef48-ce91-44a6-a681-6f6f66ea2602",
              "leftValue": "={{ $json.id }}",
              "rightValue": "",
              "operator": {
                "type": "number",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        -3520,
        -1376
      ],
      "id": "7bc545fe-1126-4435-83de-f34cfd487b7f",
      "name": "filtra tel lead",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "content": "## VERIFICA STATUS",
        "height": 222,
        "width": 607,
        "color": 4
      },
      "id": "4f729f4a-a3f3-4c3b-be5c-e04cc32c124a",
      "name": "Sticky Note20",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -3744,
        -1440
      ]
    },
    {
      "parameters": {
        "content": "",
        "width": 166,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -5952,
        -1296
      ],
      "typeVersion": 1,
      "id": "0334d61d-59ca-4738-ac78-a30fc17a9f9a",
      "name": "Sticky Note27"
    }
  ],
  "pinData": {
    "fup": [
      {
        "json": {
          "headers": {
            "host": "webhook1.lexa-ia.com",
            "user-agent": "axios/1.8.3",
            "content-length": "1375",
            "accept": "application/json,text/html,application/xhtml+xml,application/xml,text/*;q=0.9, image/*;q=0.8, */*;q=0.7",
            "accept-encoding": "gzip, compress, deflate, br",
            "content-type": "application/json",
            "x-forwarded-for": "172.18.0.1",
            "x-forwarded-host": "webhook1.lexa-ia.com",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "8cac176a95f8",
            "x-real-ip": "172.18.0.1"
          },
          "params": {},
          "query": {},
          "body": {
            "Instancia": "KRUGER",
            "Whatsapp": "5191539721",
            "Nome_cliente": null,
            "Data_mensagem": "24/10/2025",
            "Id_database_row": 6204,
            "Tag": "TRIAGEM ",
            "Horario_da_ultima_mensagem": "15:32:23",
            "dominio": "lexa-ia.com",
            "servidor": "1",
            "execution": "224986",
            "DecisaoFollowup": "# Objetivo\nVocê será uma ferramenta de análise de mensagens de texto de conversas entre vendedores e clientes. Sua tarefa é avaliar o tom e a intenção de cada mensagem recebida e classificar como \"pergunta\" ou \"final\". \n\n# Instruções\n1. Analise a mensagem recebida e determine se ela indica interesse em continuar a conversa (como uma pergunta ou comentário que espera resposta) ou se ela tem a intenção de encerrar a interação (como \"tchau\", \"fico à disposição\", \"qualquer coisa me avise\", etc.).\n2. Sua resposta deve ser exclusivamente uma palavra: \n   - Use \"pergunta\" para mensagens que indicam interesse em continuar a conversa.\n   - Use \"final\" para mensagens que indicam encerramento da conversa.\n3. Ignore qualquer outro contexto além do significado e intenção da mensagem.\n\n# Output\nResponda apenas com uma única palavra: \"pergunta\" ou \"final\".\n\n",
            "resposta_ia": "Oi! Seja bem-vindo(a)! 😊 Eu sou a Adriana, atendente na Kruger Toledo Advocacia, especialistas em gestão de passivos bancários. Antes de seguir, posso saber seu nome?",
            "horario_comercial": null
          },
          "webhookUrl": "https://webhook1.lexa-ia.com/webhook/followupchatbotsdrkruger",
          "executionMode": "production"
        }
      }
    ],
    "recebe dados": [
      {
        "json": {
          "headers": {
            "host": "webhook1.lexa-ia.com",
            "user-agent": "axios/1.8.3",
            "content-length": "15778",
            "accept": "application/json,text/html,application/xhtml+xml,application/xml,text/*;q=0.9, image/*;q=0.8, */*;q=0.7",
            "accept-encoding": "gzip, compress, deflate, br",
            "content-type": "application/json",
            "x-forwarded-for": "172.18.0.1",
            "x-forwarded-host": "webhook1.lexa-ia.com",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "8cac176a95f8",
            "x-real-ip": "172.18.0.1"
          },
          "params": {},
          "query": {},
          "body": {
            "Nome": null,
            "Whatsapp": "5191539721",
            "Funil": null,
            "Mensagem": "\n\nvamos cancelar",
            "Tag": null,
            "Instancia": "LEXA",
            "GrupoZap": "",
            "estado_atual": "AGENDAMENTO_CONFIRMAR_E_CRIAR",
            "missao_prompt": "**DESATIVE O PASSO 2 DE VERIFICAÇÃO DA ULTIMA MENSAGEM E SIGA PARA A ROTA DE PERSISTENCIA NA PRIMEIRA VEZ QUE CHEGAR NESSA ROTA**  \n\nO cliente confirmou um horário! Sua missão é: \n-PASSO 1 - usar a ferramenta 'criar_evento' para criar o evento. \n- PASSO 2 - Depois, confirmar verbalmente a escolha, parabenizá-lo e informar que você está criando o evento na agenda para oficializar. DIGA: 'Excelente escolha! Confirmado para {{horario_agendado}}. Nossa equipe vai entrar em contato para relembrar do compromisso'. Extraia o horário final para 'horario_agendado'.",
            "rotas_disponiveis": "{\n  \"rota_de_sucesso\": \n[{\"estado\": \"SUPORTE\",\"descricao\": \"Utilize esta rota após criar o evento (quando 'agendamento_confirmado' estiver preenchido).\"}],\n\n  \"rota_de_persistencia\": \n[{\"estado\": \"AGENDAMENTO_CONFIRMAR_E_CRIAR\",\"descricao\": \"Utilize esta rota se ainda não houver valor em 'agendamento_confirmado'.\"}],\n  \"rota_de_escape\": []\n}\n",
            "ferramentas": "datacrazy",
            "log": "\n\n<bloco> ############\n- Nº Execução: 162883\n\n- Usuário: \nboa noite, meu nome é João. Estou entrando em contato com vocês pra conhecer mais da IA e melhorar meus agendamentos. Minha fonte de aquisição é tráfego pago. Sou eu o responsável pelo meu comercial/atendimento no escritório e estou satisfeito com os resultados. Minha principal dificuldade pra vender mais é falta de leads. Faturo 100k/mês. Pode agendar uma conversa pra eu ver tudo funcionando.\n\n- Resposta IA: \nJoão, boa noite! Entendi que sua principal dificuldade hoje é a falta de leads, mesmo com um bom trabalho no tráfego pago. Nossa IA pode potencializar muito sua geração de clientes: ela automatiza todo o atendimento no WhatsApp, faz a qualificação comercial em tempo real e pode até fechar contratos sozinha. E tudo isso integrado ao funil para captação mais eficiente, desde a atração até o fechamento, sempre otimizando os resultados do seu próprio investimento em tráfego.\n\nPara agendar uma conversa com nossa equipe, tenho estes dois horários: 6/10, às 11h ou às 12h. Qual prefere?\n\n- Dados:\n{\"nome_cliente\":\"João\",\"motivacao\":\"conhecer mais da IA e melhorar meus agendamentos\",\"fonte_clientes\":\"tráfego pago\",\"responsavel_comercial\":\"Sou eu o responsável pelo meu comercial/atendimento no escritório\",\"dificuldade_vendas\":\"falta de leads\",\"faturamento_mensal\":100000,\"interesse_reunião\":\"Pode agendar uma conversa pra eu ver tudo funcionando.\"}\n\n- Pensamento IA: \n==============================\nPensamento 1\n------------------------------\n- Estado atual: INICIO\n\njson{\n  \"pensamento\": [\n    \"Iniciando execução conforme as Leis.\",\n    \"PASSO 1: VERIFICAÇÃO DE MEMÓRIA\",\n    \"- CHAVE_DE_VALIDACAO_DO_ESTADO: 'nome_cliente'.\",\n    \"- CONDIÇÃO NORMAL: Verificando existência da chave exata 'nome_cliente' em DADOS_JÁ_COLETADOS.\",\n    \"- A chave 'nome_cliente' existe com valor 'João' (não-nulo, tipo válido: string).\",\n    \"- VEREDITO: SUCESSO IMEDIATO.\",\n    \"- Ignorando HISTÓRICO e PASSO 2.\",\n    \"LÓGICA DE SELEÇÃO DE ROTA\",\n    \"- Veredito SUCESSO: Escolhendo 'rota_de_sucesso'.\",\n    \"- Dentro de 'rota_de_sucesso', única opção é estado 'PERGUNTAR_FONTE_AQUISICAO' cuja descrição corresponde a 'Após receber a primeira mensagem e já ter um nome pelo qual possa chamar o cliente.'\",\n    \"CONCLUSÃO\",\n    \"- Estado escolhido: 'PERGUNTAR_FONTE_AQUISICAO'.\"\n  ],\n  \"estado_escolhido\": \"PERGUNTAR_FONTE_AQUISICAO\"\n}\n\n==============================\nPensamento 2\n------------------------------\n- Estado atual: PERGUNTAR_FONTE_AQUISICAO\n\njson{\n  \"pensamento\": [\n    \"Iniciando execução conforme as Leis.\",\n    \"PASSO 1: VERIFICAÇÃO DE MEMÓRIA\",\n    \"- CHAVE_DE_VALIDACAO_DO_ESTADO: 'motivacao'.\",\n    \"- CONDIÇÃO NORMAL: Verificando se a chave 'motivacao' existe em DADOS_JÁ_COLETADOS.\",\n    \"- A chave existe com valor 'conhecer mais da IA e melhorar meus agendamentos' (tipo válido: string, não-nulo).\",\n    \"- VEREDITO: SUCESSO IMEDIATO.\",\n    \"- Ignorando HISTÓRICO e PASSO 2 conforme regra.\",\n    \"LÓGICA DE SELEÇÃO DE ROTA\",\n    \"- Veredito SUCESSO: Escolhendo a primeira rota em 'rota_de_sucesso'.\",\n    \"- Estado: 'NECESSIDADE'.\",\n    \"CONCLUSÃO\",\n    \"- Estado escolhido: 'NECESSIDADE'.\"\n  ],\n  \"estado_escolhido\": \"NECESSIDADE\"\n}\n\n==============================\nPensamento 3\n------------------------------\n- Estado atual: NECESSIDADE\n\njson{\n  \"pensamento\": [\n    \"Iniciando execução conforme as Leis.\",\n    \"PASSO 1: VERIFICAÇÃO DE MEMÓRIA\",\n    \"- CHAVE_DE_VALIDACAO_DO_ESTADO: 'necessidade'.\",\n    \"- CONDIÇÃO NORMAL: Verificando existência da chave 'necessidade' em DADOS_JÁ_COLETADOS.\",\n    \"- Chave 'necessidade' não encontrada em DADOS_JÁ_COLETADOS.\",\n    \"- VEREDITO: PENDENTE.\",\n    \"PASSO 2: ANÁLISE DA MENSAGEM\",\n    \"- Analisando última mensagem do cliente para verificar se fornece informação clara e relevante para a chave 'necessidade'.\",\n    \"- Última mensagem do cliente contém fala explicita: 'Minha principal dificuldade pra vender mais é falta de leads'.\",\n    \"- A mensagem apresenta contexto claro, sem ambiguidade e corresponde diretamente à missão do estado atual.\",\n    \"- VEREDITO: SUCESSO.\",\n    \"LÓGICA DE SELEÇÃO DE ROTA\",\n    \"- Para veredito SUCESSO, escolher rota_de_sucesso.\",\n    \"- Única opção em rota_de_sucesso é estado 'SOLICITAR_INTERESSE_AGENDAMENTO' com descrição apropriada.\",\n    \"CONCLUSÃO\",\n    \"- Estado escolhido: 'SOLICITAR_INTERESSE_AGENDAMENTO'.\"\n  ],\n  \"estado_escolhido\": \"SOLICITAR_INTERESSE_AGENDAMENTO\"\n}\n\n==============================\nPensamento 4\n------------------------------\n- Estado atual: SOLICITAR_INTERESSE_AGENDAMENTO\n\njson{\n  \"pensamento\": [\n    \"Iniciando execução conforme as Leis.\",\n    \"PASSO 1: VERIFICAÇÃO DE MEMÓRIA\",\n    \"- CHAVE_DE_VALIDACAO_DO_ESTADO: 'interesse_reunião'.\",\n    \"- CONDIÇÃO NORMAL: A chave existe em DADOS_JÁ_COLETADOS com valor 'Pode agendar uma conversa pra eu ver tudo funcionando.' (não-nulo, tipo válido: string).\",\n    \"- VERIFICANDO tipo e conteúdo da resposta para validar interesse em agendar reunião.\",\n    \"- Mensagem do cliente demonstra claro interesse em agendar reunião, pois contém expressão explícita 'Pode agendar uma conversa pra eu ver tudo funcionando.' que indica concordância.\",\n    \"- VEREDITO: SUCESSO IMEDIATO.\",\n    \"- Ignorando HISTÓRICO e PASSO 2.\",\n    \"LÓGICA DE SELEÇÃO DE ROTA\",\n    \"- Veredito SUCESSO: Escolhendo rota_de_sucesso.\",\n    \"- Avaliando rotas de sucesso disponíveis:\",\n    \"  * AGENDAMENTO_INICIAR_E_SUGERIR: 'Use esta rota se o cliente disser 'sim' ou expressar claro interesse.' É a descrição que melhor corresponde ao valor obtido.\",\n    \"  * QUEBRAR_OBJECAO: para negativa ou hesitação, não aplicável.\",\n    \"- Escolhido estado: 'AGENDAMENTO_INICIAR_E_SUGERIR'.\",\n    \"CONCLUSÃO\",\n    \"- Estado escolhido: 'AGENDAMENTO_INICIAR_E_SUGERIR'.\"\n  ],\n  \"estado_escolhido\": \"AGENDAMENTO_INICIAR_E_SUGERIR\"\n}\n\n==============================\nPensamento 5\n------------------------------\n- Estado atual: AGENDAMENTO_INICIAR_E_SUGERIR\n\njson{\n  \"pensamento\": [\n    \"Iniciando execução conforme as Leis.\",\n    \"PASSO 1: VERIFICAÇÃO DE MEMÓRIA\",\n    \"- CHAVE_DE_VALIDACAO_DO_ESTADO: 'horario_escolhido'.\",\n    \"- CONDIÇÃO NORMAL: Verificando existência da chave em DADOS_JÁ_COLETADOS.\",\n    \"- A chave 'horario_escolhido' NÃO existe em DADOS_JÁ_COLETADOS.\",\n    \"- VEREDITO: PENDENTE, pois o valor esperado não está disponível.\",\n    \"PASSO 2: ANÁLISE DA MENSAGEM (VEREDITO FINAL)\",\n    \"- Última mensagem do cliente: 'boa noite, meu nome é João. Estou entrando em contato com vocês pra conhecer mais da IA e melhorar meus agendamentos. Minha fonte de aquisição é tráfego pago. Sou eu o responsável pelo meu comercial/atendimento no escritório e estou satisfeito com os resultados. Minha principal dificuldade pra vender mais é falta de leads. Faturo 100k/mês. Pode agendar uma conversa pra eu ver tudo funcionando.'.\",\n    \"- Mensagem é uma introdução e pedido geral, sem indicação clara de horário específico para agendamento.\",\n    \"- Mensagem não fornece informação clara e específica para 'horario_escolhido' (não indica dia + horário específico).\",\n    \"- VEREDITO de mensagem: FALHA, pois a resposta não atende ao critério de confirmação de horário claro.\",\n    \"LÓGICA DE SELEÇÃO DE ROTA\",\n    \"- Veredito FALHA: Proibido escolher rota_de_sucesso.\",\n    \"- Verificando rotas de persistencia e escape disponíveis.\",\n    \"- 'rota_de_persistencia' contém AGENDAMENTO_INICIAR_E_SUGERIR, rota de escape contém DESCARTE.\",\n    \"- Escolhendo rota_de_persistencia priorizando persistência para obter resposta válida.\",\n    \"CONCLUSÃO\",\n    \"- Estado escolhido: 'AGENDAMENTO_INICIAR_E_SUGERIR'.\"\n  ],\n  \"estado_escolhido\": \"AGENDAMENTO_INICIAR_E_SUGERIR\"\n}\n</bloco> ############\n\n<bloco> ############\n- Nº Execução: 162891\n\n- Usuário: \n6/10, às 11h\n\n- Resposta IA: \nExcelente escolha, João! Confirmado para 6 de outubro de 2025, às 11h. Estou criando o evento na agenda agora para oficializar. Nossa equipe vai entrar em contato para relembrar do compromisso.\n\nAproveitando: o que você espera ver de mais prático nessa demonstração da IA no atendimento comercial?\n\n- Dados:\n{\"nome_cliente\":\"João\",\"motivacao\":\"conhecer mais da IA e melhorar meus agendamentos\",\"fonte_clientes\":\"tráfego pago\",\"responsavel_comercial\":\"Sou eu o responsável pelo meu comercial/atendimento no escritório\",\"dificuldade_vendas\":\"falta de leads\",\"faturamento_mensal\":100000,\"interesse_reunião\":\"Pode agendar uma conversa pra eu ver tudo funcionando\",\"vontade_trafego\":\"conhecer mais da IA e melhorar meus agendamentos\",\"horario_escolhido\":\"6/10, às 11h\"}\n\n- Pensamento IA: \n==============================\nPensamento 1\n------------------------------\n- Estado atual: AGENDAMENTO_INICIAR_E_SUGERIR\n\njson{\n  \"pensamento\": [\n    \"Iniciando execução conforme as Leis.\",\n    \"PASSO 1: VERIFICAÇÃO DE MEMÓRIA\",\n    \"- CHAVE_DE_VALIDACAO_DO_ESTADO: 'horario_escolhido'.\",\n    \"- CONDIÇÃO NORMAL: A chave existe em DADOS_JÁ_COLETADOS com valor '6/10, às 11h' (não-nulo, tipo válido: string).\",\n    \"- VEREDITO: SUCESSO IMEDIATO.\",\n    \"- Ignorando HISTÓRICO e PASSO 2.\",\n    \"LÓGICA DE SELEÇÃO DE ROTA\",\n    \"- Veredito SUCESSO: Analisando rota_de_sucesso para correspondência de descrição com o valor específico fornecido.\",\n    \"- Valor do horário específico ('6/10, às 11h') corresponde exatamente à descrição da primeira rota_de_sucesso: 'Use apenas se o cliente ACEITAR um dos horários sugeridos pela IA (exemplo: 'prefiro sexta às 10h')'.\",\n    \"- Escolhendo estado 'AGENDAMENTO_CONFIRMAR_E_CRIAR'.\",\n    \"CONCLUSÃO\",\n    \"- Estado escolhido: 'AGENDAMENTO_CONFIRMAR_E_CRIAR'.\"\n  ],\n  \"estado_escolhido\": \"AGENDAMENTO_CONFIRMAR_E_CRIAR\"\n}\n\n==============================\nPensamento 2\n------------------------------\n- Estado atual: AGENDAMENTO_CONFIRMAR_E_CRIAR\n\njson{\n  \"pensamento\": [\n    \"Iniciando execução conforme as Leis.\",\n    \"PASSO 1: VERIFICAÇÃO DE MEMÓRIA\",\n    \"- CHAVE_DE_VALIDACAO_DO_ESTADO: 'agendamento_confirmado'.\",\n    \"- CONDIÇÃO NORMAL: Verificando existência da chave 'agendamento_confirmado' em DADOS_JÁ_COLETADOS.\",\n    \"- A chave 'agendamento_confirmado' não está presente em DADOS_JÁ_COLETADOS.\",\n    \"- VEREDITO: PENDENTE, pois a chave não existe ou está inválida.\",\n    \"De acordo com a missão do estado atual, DESATIVAREI o PASSO 2 e seguirei diretamente para a rota de persistência na primeira vez que chegar aqui.\",\n    \"LÓGICA DE SELEÇÃO DE ROTA\",\n    \"- Veredito FALHA (pendente sem dado válido): escolher rota_de_persistencia preferencialmente.\",\n    \"- rota_de_persistencia possui a rota 'AGENDAMENTO_CONFIRMAR_E_CRIAR' com descrição apropriada.\",\n    \"- Estado escolhido: 'AGENDAMENTO_CONFIRMAR_E_CRIAR'.\",\n    \"CONCLUSÃO\",\n    \"- Estado escolhido: 'AGENDAMENTO_CONFIRMAR_E_CRIAR'.\"\n  ],\n  \"estado_escolhido\": \"AGENDAMENTO_CONFIRMAR_E_CRIAR\"\n}\n</bloco> ############\n\n<bloco> ############\n- Nº Execução: 162970\n\n- Usuário: \nquero cancelar meu agendamento\n\n- Resposta IA: \nEntendi, João, você quer cancelar o agendamento do dia 6 de outubro, às 11h. Só para entender melhor e ajustar a agenda: prefere remarcar para outro horário ou precisa pausar esse contato por enquanto?\n\n- Dados:\n{\"nome_cliente\":\"João\",\"motivacao\":\"conhecer mais da IA e melhorar meus agendamentos\",\"fonte_clientes\":\"tráfego pago\",\"responsavel_comercial\":\"Sou eu o responsável pelo meu comercial/atendimento no escritório\",\"dificuldade_vendas\":\"falta de leads\",\"faturamento_mensal\":100000,\"interesse_reunião\":\"Pode agendar uma conversa pra eu ver tudo funcionando\",\"vontade_trafego\":\"conhecer mais da IA e melhorar meus agendamentos\",\"horario_escolhido\":\"6/10, às 11h\",\"experiencia_trafego\":true}\n\n- Pensamento IA: \n==============================\nPensamento 1\n------------------------------\n- Estado atual: AGENDAMENTO_CONFIRMAR_E_CRIAR\n\njson{\n  \"pensamento\": [\n    \"Iniciando execução conforme as Leis.\",\n    \"PASSO 1: VERIFICAÇÃO DE MEMÓRIA\",\n    \"- CHAVE_DE_VALIDACAO_DO_ESTADO: 'agendamento_confirmado'.\",\n    \"- CONDIÇÃO NORMAL: Verificando se a chave existe em DADOS_JÁ_COLETADOS.\",\n    \"- A chave 'agendamento_confirmado' NÃO existe em DADOS_JÁ_COLETADOS.\",\n    \"- VEREDITO: PENDENTE, portanto prosseguir para PASSO 2.\",\n    \"PASSO 2: ANÁLISE DA MENSAGEM (VEREDITO FINAL)\",\n    \"- Verificação da última mensagem do cliente: 'quero cancelar meu agendamento'.\",\n    \"- Verificar alinhamento com objetivo atual: a resposta não valida que o agendamento foi confirmado; uma mensagem de cancelamento é ambígua/falha para confirmação.\",\n    \"- Segundo a MISSÃO, PASSO 2 está DESATIVADO para esta rota e na primeira vez nesta rota devemos ir para rota_de_persistencia.\",\n    \"LÓGICA DE SELEÇÃO DE ROTA\",\n    \"- VEREDITO é considerado FALHA (cancelamento não confirma agendamento).\",\n    \"- Portanto, PROIBIDO escolher rota_de_sucesso.\",\n    \"- Escolher rota_de_persistencia (preferida) ou rota_de_escape (se persistencia vazia).\",\n    \"- Rota_de_persistencia disponível: AGENDAMENTO_CONFIRMAR_E_CRIAR.\",\n    \"CONCLUSÃO\",\n    \"- Estado escolhido: 'AGENDAMENTO_CONFIRMAR_E_CRIAR'.\"\n  ],\n  \"estado_escolhido\": \"AGENDAMENTO_CONFIRMAR_E_CRIAR\"\n}\n</bloco> ############",
            "dados": "{\"nome_cliente\":\"João\",\"motivacao\":\"conhecer mais da IA e melhorar meus agendamentos\",\"fonte_clientes\":\"tráfego pago\",\"responsavel_comercial\":\"Sou eu o responsável pelo meu comercial/atendimento no escritório\",\"dificuldade_vendas\":\"falta de leads\",\"faturamento_mensal\":100000,\"interesse_reunião\":\"Pode agendar uma conversa pra eu ver tudo funcionando\",\"vontade_trafego\":\"conhecer mais da IA e melhorar meus agendamentos\",\"horario_escolhido\":\"6/10, às 11h\",\"experiencia_trafego\":true}",
            "midia": "conversation",
            "execution": "163306"
          },
          "webhookUrl": "https://webhook1.lexa-ia.com/webhook/chatbotsdrlexa",
          "executionMode": "production"
        }
      }
    ]
  },
  "connections": {
    "Convert to File": {
      "main": [
        [
          {
            "node": "cria base conhecimento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Data Loader": {
      "ai_document": [
        [
          {
            "node": "cria base conhecimento",
            "type": "ai_document",
            "index": 0
          }
        ]
      ]
    },
    "Recursive Character Text Splitter": {
      "ai_textSplitter": [
        [
          {
            "node": "Data Loader",
            "type": "ai_textSplitter",
            "index": 0
          }
        ]
      ]
    },
    "zera bc": {
      "main": [
        [
          {
            "node": "Filter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter": {
      "main": [
        [
          {
            "node": "puxa conhecimento1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "3dias": {
      "main": [
        [
          {
            "node": "instancia",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "dados bc": {
      "main": [
        [
          {
            "node": "zera bc",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "instancia": {
      "main": [
        [
          {
            "node": "dados bc",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "puxa conhecimento1": {
      "main": [
        [
          {
            "node": "Convert to File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "gpt8": {
      "ai_embedding": [
        [
          {
            "node": "cria base conhecimento",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "campos followup": {
      "main": [
        [
          {
            "node": "puxa lead fup",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "avalia msg": {
      "main": [
        [
          {
            "node": "pergunta ou final",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "verifica nova msg": {
      "main": [
        [],
        [
          {
            "node": "pula delay minutagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "pergunta ou final": {
      "main": [
        [
          {
            "node": "tipo midia",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "horario especifico": {
      "main": [
        [
          {
            "node": "aguarda especifico",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "aguarda minutagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "aguarda especifico": {
      "main": [
        [
          {
            "node": "comercial",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "responde fup": {
      "main": [
        [
          {
            "node": "highlight fup",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "comercial": {
      "main": [
        [
          {
            "node": "filtro horario",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "puxa status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "on off": {
      "main": [
        [
          {
            "node": "nova msg",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "aguarda minutagem": {
      "main": [
        [
          {
            "node": "comercial",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "tipo midia": {
      "main": [
        [
          {
            "node": "variavel texto",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "envia imagem",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "envia audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "envia texto": {
      "main": [
        [
          {
            "node": "atualiza fup",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "envia imagem": {
      "main": [
        [
          {
            "node": "atualiza fup",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "envia audio": {
      "main": [
        [
          {
            "node": "atualiza fup",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "atualiza fup": {
      "main": [
        [
          {
            "node": "evento fup",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "calcula horas": {
      "main": [
        [
          {
            "node": "telefone testes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "fup": {
      "main": [
        [
          {
            "node": "responde fup",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "puxa lead fup": {
      "main": [
        [
          {
            "node": "fup existe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "followup final": {
      "main": [
        [
          {
            "node": "calcula horas",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "crm descarte",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "nova msg": {
      "main": [
        [
          {
            "node": "verifica nova msg",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "filtro horario": {
      "main": [
        [
          {
            "node": "verifica liberacao",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "verifica liberacao": {
      "main": [
        [
          {
            "node": "puxa status",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "aguarda comercial",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "puxa status": {
      "main": [
        [
          {
            "node": "on off",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "telefone testes": {
      "main": [
        [
          {
            "node": "aguarda testes",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "horario especifico",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "aguarda testes": {
      "main": [
        [
          {
            "node": "comercial",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "aguarda comercial": {
      "main": [
        [
          {
            "node": "filtro horario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "evento fup": {
      "main": [
        [
          {
            "node": "proximo fup",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "crm descarte": {
      "main": [
        [
          {
            "node": "descarte crm externo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "pula delay minutagem": {
      "main": [
        [
          {
            "node": "tipo midia",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "pula delay especifico",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "pula delay especifico": {
      "main": [
        [
          {
            "node": "tipo midia",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "avalia msg",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "variavel texto": {
      "main": [
        [
          {
            "node": "envia texto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "highlight fup": {
      "main": [
        [
          {
            "node": "campos followup",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "gpt10": {
      "ai_languageModel": [
        [
          {
            "node": "avalia msg",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "fup existe": {
      "main": [
        [
          {
            "node": "followup final",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "RESPONDE NO ZAP - TEXTO": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [
          {
            "node": "zera",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "RESPONDE NO ZAP - TEXTO",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "salva msg banco de dados": {
      "main": [
        [
          {
            "node": "salva msg ia bubble",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "procura primeira msg": {
      "main": [
        [
          {
            "node": "verifica se já tem mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "dados mensagem": {
      "main": [
        [
          {
            "node": "dados base",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "salva primeira msg banco de dados": {
      "main": [
        [
          {
            "node": "avisa novo contato zap",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "verifica se já tem mensagem": {
      "main": [
        [
          {
            "node": "puxa dados",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "salva primeira msg banco de dados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "picota respostas da IA": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "separa mensagens da ia": {
      "main": [
        [
          {
            "node": "picota respostas da IA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "recebe dados": {
      "main": [
        [
          {
            "node": "responde zap",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "atualiza state",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Vector Store Tool": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "puxa conhecimento": {
      "ai_vectorStore": [
        [
          {
            "node": "Vector Store Tool",
            "type": "ai_vectorStore",
            "index": 0
          }
        ]
      ]
    },
    "avisa novo contato zap": {
      "main": [
        [
          {
            "node": "puxa dados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "condicional fup": {
      "main": [
        [
          {
            "node": "fluxo do followup",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "fluxo do followup": {
      "main": [
        [
          {
            "node": "evento completo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "memoria": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "avalia falta resposta": {
      "main": [
        [
          {
            "node": "com ou sem resposta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "com ou sem resposta": {
      "main": [
        [
          {
            "node": "audio ou texto",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "audio ou texto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "cria row tag off": {
      "main": [
        [
          {
            "node": "envia aviso zap",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "envia aviso zap": {
      "main": [
        [
          {
            "node": "avisa cliente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "salva msg ia bubble": {
      "main": [
        [
          {
            "node": "cria msg bubble ia",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "dados base": {
      "main": [
        [
          {
            "node": "puxa agente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "atualiza state": {
      "main": [
        [
          {
            "node": "salva msg banco de dados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "verifica ferramenta": {
      "main": [
        [
          {
            "node": "verifica crm",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "usa ferramenta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "usa ferramenta": {
      "main": [
        [
          {
            "node": "verifica crm",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "criar_evento": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "atualiza log": {
      "main": [
        [
          {
            "node": "avalia falta resposta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "puxa agente": {
      "main": [
        [
          {
            "node": "apaga loops",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "gpt3": {
      "ai_embedding": [
        [
          {
            "node": "puxa conhecimento",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "gpt4": {
      "ai_languageModel": [
        [
          {
            "node": "Vector Store Tool",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "gpt5": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "gpt6": {
      "ai_languageModel": [
        [
          {
            "node": "avalia falta resposta",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "gpt7": {
      "ai_languageModel": [
        [
          {
            "node": "separa mensagens da ia",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "responde zap": {
      "main": [
        [
          {
            "node": "highlight",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "puxa log": {
      "main": [
        [
          {
            "node": "ordena logs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "concatena logs": {
      "main": [
        [
          {
            "node": "atualiza log",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "deleta logs temp": {
      "main": [
        [
          {
            "node": "puxa mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "apaga loops": {
      "main": [
        [
          {
            "node": "deleta logs temp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "puxa memoria": {
      "main": [
        [
          {
            "node": "concatena memoria",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "concatena memoria": {
      "main": [
        [
          {
            "node": "extrai dados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "escolhe state": {
      "main": [
        [
          {
            "node": "extrai state",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "extrai state": {
      "main": [
        [
          {
            "node": "cria log",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "extrai dados": {
      "main": [
        [
          {
            "node": "dados extracao",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "atualiza dados": {
      "main": [
        [
          {
            "node": "puxa regras",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "dados extracao": {
      "main": [
        [
          {
            "node": "concatena dados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "concatena dados": {
      "main": [
        [
          {
            "node": "atualiza dados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "avalia state": {
      "main": [
        [
          {
            "node": "verifica ferramenta",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "puxa loops",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "puxa regras": {
      "main": [
        [
          {
            "node": "escolhe state",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "novo state": {
      "main": [
        [
          {
            "node": "puxa regras",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "gpt1": {
      "ai_languageModel": [
        [
          {
            "node": "extrai dados",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "gpt2": {
      "ai_languageModel": [
        [
          {
            "node": "escolhe state",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "cria log": {
      "main": [
        [
          {
            "node": "cria loop",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "avalia loop": {
      "main": [
        [
          {
            "node": "verifica ferramenta",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "novo state",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "cria loop": {
      "main": [
        [
          {
            "node": "avalia state",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "puxa loops": {
      "main": [
        [
          {
            "node": "conta loops",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "conta loops": {
      "main": [
        [
          {
            "node": "avalia loop",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ordena logs": {
      "main": [
        [
          {
            "node": "concatena logs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "junta dados": {
      "main": [
        [
          {
            "node": "puxa memoria",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "puxa dados": {
      "main": [
        [
          {
            "node": "junta dados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "zera": {
      "main": [
        [
          {
            "node": "verifica midia",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "verifica midia": {
      "main": [
        [
          {
            "node": "condicional fup",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "puxa midia",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "puxa midia": {
      "main": [
        [
          {
            "node": "midia pra base64",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "envia midia": {
      "main": [
        [
          {
            "node": "condicional fup",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "extrai tipo": {
      "main": [
        [
          {
            "node": "envia midia",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "midia pra base64": {
      "main": [
        [
          {
            "node": "extrai tipo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "audio ou texto": {
      "main": [
        [
          {
            "node": "cria audio",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "separa mensagens da ia",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "cria audio": {
      "main": [
        [
          {
            "node": "base64 audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "envia audio zap": {
      "main": [
        [
          {
            "node": "zera",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "base64 audio": {
      "main": [
        [
          {
            "node": "envia audio zap",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "puxa mensagens": {
      "main": [
        [
          {
            "node": "testa pra ver se ja tem msg",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "testa pra ver se ja tem msg": {
      "main": [
        [
          {
            "node": "salva outras msgs",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "salva primeira msg",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "salva primeira msg": {
      "main": [
        [
          {
            "node": "pula timer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "puxa mensagens1": {
      "main": [
        [
          {
            "node": "agrupa mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "apaga as msgs": {
      "main": [
        [
          {
            "node": "testa fone sem 9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "agrupa mensagens": {
      "main": [
        [
          {
            "node": "apaga as msgs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "pula timer": {
      "main": [
        [
          {
            "node": "puxa mensagens1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "delay",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "delay": {
      "main": [
        [
          {
            "node": "puxa mensagens1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "atualiza crm": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "verifica crm": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "atualiza crm",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "data hora": {
      "main": [
        [
          {
            "node": "dados mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "highlight": {
      "main": [
        [
          {
            "node": "data hora",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "gerenciar_agenda": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "apagar_evento": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "cria msg bubble ia": {
      "main": [
        [
          {
            "node": "puxa log",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Status": {
      "main": [
        [],
        [
          {
            "node": "procura primeira msg",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "testa fone sem 9": {
      "main": [
        [
          {
            "node": "filtra tel lead",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "filtra tel lead": {
      "main": [
        [
          {
            "node": "Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "callerPolicy": "workflowsFromSameOwner",
    "executionOrder": "v0",
    "errorWorkflow": "8HGeEkJdRI01UGR2"
  },
  "versionId": "2e5af019-c576-490b-b188-a381f2f78d05",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "c3cf5738819e614e277c0d56c04b8adf7599f9d1cf7b2c414abde335eedf59ed"
  },
  "id": "grt2ewfrShDOSrZk",
  "tags": []
}